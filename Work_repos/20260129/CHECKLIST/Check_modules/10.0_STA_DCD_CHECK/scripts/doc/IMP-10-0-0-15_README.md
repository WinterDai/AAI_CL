# IMP-10-0-0-15: Confirm the double_clock check result is clean.

## Overview

**Check ID:** IMP-10-0-0-15  
**Description:** Confirm the double_clock check result is clean.  
**Category:** Static Timing Analysis (STA) - Design Rule Check  
**Input Files:** `${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt`

This checker validates that no double clocking violations exist in the design. Double clocking occurs when a signal is clocked by multiple clock domains, potentially causing metastability issues. The checker parses timing analysis reports (from Tempus/PrimeTime) to identify instances where pins exhibit reverse swing/slope characteristics indicating double clocking behavior. A clean report (headers present but no violations) indicates PASS; any violations listed indicate FAIL.

---

## Check Logic

### Input Parsing
The checker processes double clocking reports generated by timing analysis tools. Each report contains one or more views (timing corners), with potential violations listed under column headers.

**Key Patterns:**
```python
# Pattern 1: View name extraction
pattern1 = r'Double Clocking Report For View:\s+([\w\d_]+)'
# Example: "        Double Clocking Report For View: at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold"

# Pattern 2: Report timestamp
pattern2 = r'Generated:\s+(.+?)\s*$'
# Example: "        Generated: Wed Sep 10 13:44:26 2025"

# Pattern 3: Column header detection (marks violation section start)
pattern3 = r'^Instance Pin\s+Transition Type\s+Reverse Swing\s+Reverse Slope'
# Example: "Instance Pin    Transition Type    Reverse Swing    Reverse Slope"

# Pattern 4: Violation entry
pattern4 = r'^([\w\d_/]+)\s+(\w+)\s+([\d.]+(?:e[+-]?\d+)?)\s+([\d.]+(?:e[+-]?\d+)?)'
# Example: "core/clk_gate_inst/CK    rise    1.234e-09    2.456e-10"

# Pattern 5: Section delimiter
pattern5 = r'^\*{50,}'
# Example: "********************************************************************************"
```

### Detection Logic
1. **File Discovery**: Locate all `double_clock_*.rpt` files matching the glob pattern
2. **State Machine Parsing**:
   - INIT: Search for report header
   - HEADER_FOUND: Extract view name and timestamp
   - COLUMN_HEADER_FOUND: Detect violation section start
   - VIOLATION_SECTION: Parse violation entries (instance/pin, transition type, reverse swing/slope)
3. **Violation Detection**: Any non-empty line matching pattern4 after column headers = violation
4. **Clean Report Detection**: Column headers present but no violation lines = PASS
5. **Aggregation**: Collect violations from all files, group by view name
6. **Result Classification**:
   - No violations across all views → PASS
   - Any violations found → FAIL (unless waived)

**Edge Cases**:
- Empty file → ERROR (corrupted report)
- Header only, no violations → PASS (clean report)
- Multiple views in single file → Track view context per violation
- Truncated file with limit message → Flag as potentially incomplete
- No column header → ERROR (malformed report)

---

## Output Descriptions (CRITICAL - Code Generator Uses These!)

This section defines the output strings used by `build_complete_output()` in the checker code.
**Fill in these values based on the check logic above.**

```python
# Item description for this checker
item_desc = "Confirm the double_clock check result is clean."

# PASS case - what message to show when check passes
found_reason = "All timing views are clean - no double clocking violations detected"
found_desc = "Double clocking check passed"

# FAIL case - what message to show when check fails
missing_reason = "Double clocking violations detected in one or more timing views"
missing_desc = "Double clocking check failed"

# WAIVED case (Type 3/4) - what message to show for waived items
waived_base_reason = "Double clocking violation waived per design team approval"
waived_desc = "Waived double clocking violations"

# UNUSED waivers - what message to show for unused waiver entries
unused_waiver_reason = "Waiver not matched - no corresponding double clocking violation found"
unused_desc = "Unused waiver entries"
```

### INFO01/ERROR01 Display Format

```
INFO01 (Clean/Pass items):
  Format: "View '{view_name}': No double clocking violations | Generated: {timestamp}"
  Example: "View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold': No double clocking violations | Generated: Wed Sep 10 13:44:26 2025"

ERROR01 (Violation/Fail items):
  Format: "View '{view_name}' | {instance_path}/{pin_name} | Transition: {transition_type} | Reverse Swing: {swing_value} | Reverse Slope: {slope_value}"
  Example: "View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold' | core/clk_gate_inst/CK | Transition: rise | Reverse Swing: 1.234e-09 | Reverse Slope: 2.456e-10"
```

---

## Type 1: Boolean Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-10-0-0-15:
  description: "Confirm the double_clock check result is clean."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt"
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 1 performs custom boolean checks (file exists? config valid?).
PASS/FAIL based on checker's own validation logic.

**Sample Output (PASS):**
```
Status: PASS
Reason: All timing views are clean - no double clocking violations detected
INFO01:
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold': No double clocking violations | Generated: Wed Sep 10 13:44:26 2025
  - View 'func_rcss_0p675v_125c_pcss_cmax_pcff3_setup': No double clocking violations | Generated: Wed Sep 10 13:44:26 2025
```

**Sample Output (FAIL):**
```
Status: FAIL
Reason: Double clocking violations detected in one or more timing views
ERROR01:
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold' | core/clk_gate_inst/CK | Transition: rise | Reverse Swing: 1.234e-09 | Reverse Slope: 2.456e-10
  - View 'func_rcss_0p675v_125c_pcss_cmax_pcff3_setup' | top/u_ctrl/clk_mux/SEL | Transition: fall | Reverse Swing: 3.456e-09 | Reverse Slope: 5.678e-10
```

### Type 1 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-10-0-0-15:
  description: "Confirm the double_clock check result is clean."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt"
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: Double clocking violations are informational only for this design phase"
      - "Note: Violations in test mode views are expected due to scan chain architecture and do not affect functional operation"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 1 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL violations force converted: FAIL→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (violations shown as INFO for tracking)
- Used when: Check is informational only, violations expected/acceptable

**Sample Output (PASS with violations):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All violations waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: Double clocking violations are informational only for this design phase"
  - "Note: Violations in test mode views are expected due to scan chain architecture and do not affect functional operation"
INFO02 ([WAIVED_AS_INFO] - violations converted to PASS, shown as INFO):
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold' | core/clk_gate_inst/CK | Transition: rise | Reverse Swing: 1.234e-09 | Reverse Slope: 2.456e-10 [WAIVED_AS_INFO]
  - View 'func_rcss_0p675v_125c_pcss_cmax_pcff3_setup' | top/u_ctrl/clk_mux/SEL | Transition: fall | Reverse Swing: 3.456e-09 | Reverse Slope: 5.678e-10 [WAIVED_AS_INFO]
```

---

## Type 2: Value Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-10-0-0-15:
  description: "Confirm the double_clock check result is clean."
  requirements:
    value: 2
    pattern_items:
      - "at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold"
      - "func_rcss_0p675v_125c_pcss_cmax_pcff3_setup"
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt"
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 2 searches pattern_items in input files.
PASS/FAIL depends on check purpose:
- Violation Check: PASS if found_items empty (no violations)
- Requirement Check: PASS if missing_items empty (all requirements met)

**Sample Output (PASS):**
```
Status: PASS
Reason: All timing views are clean - no double clocking violations detected
INFO01:
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold': No double clocking violations | Generated: Wed Sep 10 13:44:26 2025
  - View 'func_rcss_0p675v_125c_pcss_cmax_pcff3_setup': No double clocking violations | Generated: Wed Sep 10 13:44:26 2025
```

### Type 2 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-10-0-0-15:
  description: "Confirm the double_clock check result is clean."
  requirements:
    value: 2
    pattern_items:
      - "at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold"
      - "func_rcss_0p675v_125c_pcss_cmax_pcff3_setup"
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt"
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: This check is informational only during pre-tapeout verification"
      - "Note: Pattern mismatches in test mode views are expected and do not require fixes"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 2 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL errors/mismatches force converted: ERROR→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (errors shown as INFO for tracking)
- Used when: Pattern check is informational, mismatches expected

**Sample Output (PASS with mismatches):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All mismatches waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: This check is informational only during pre-tapeout verification"
  - "Note: Pattern mismatches in test mode views are expected and do not require fixes"
INFO02 ([WAIVED_AS_INFO] - errors converted to PASS, shown as INFO):
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold' | core/clk_gate_inst/CK | Transition: rise | Reverse Swing: 1.234e-09 | Reverse Slope: 2.456e-10 [WAIVED_AS_INFO]
```

---

## Type 3: Value Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-10-0-0-15:
  description: "Confirm the double_clock check result is clean."
  requirements:
    value: 2
    pattern_items:
      - "at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold"
      - "func_rcss_0p675v_125c_pcss_cmax_pcff3_setup"
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt"
  waivers:
    value: 2
    waive_items:
      - name: "at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold"
        reason: "Waived per design review - clock gating cell has controlled double clocking for power management"
      - name: "func_rcss_0p675v_125c_pcss_cmax_pcff3_setup"
        reason: "Approved exception - clock mux select signal has intentional multi-domain clocking with synchronizer"
```

**Check Behavior:**
Type 3 = Type 2 + waiver support.
Same pattern search logic as Type 2, plus waiver classification:
- Match found_items against waive_items
- Unwaived items → ERROR (need fix)
- Waived items → INFO with [WAIVER] tag (approved)
- Unused waivers → WARN with [WAIVER] tag
PASS if all found_items (violations) are waived.

**Sample Output (with waived items):**
```
Status: PASS
Reason: All violations waived
INFO01 (Waived):
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold' | core/clk_gate_inst/CK | Transition: rise | Reverse Swing: 1.234e-09 | Reverse Slope: 2.456e-10 [WAIVER]
  - View 'func_rcss_0p675v_125c_pcss_cmax_pcff3_setup' | top/u_ctrl/clk_mux/SEL | Transition: fall | Reverse Swing: 3.456e-09 | Reverse Slope: 5.678e-10 [WAIVER]
WARN01 (Unused Waivers):
  - View 'test_mode_scan' | scan/chain_0/mux | Transition: rise | Reverse Swing: 2.0e-09 | Reverse Slope: 1.0e-10: Waiver not matched - no corresponding double clocking violation found
```

---

## Type 4: Boolean Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-10-0-0-15:
  description: "Confirm the double_clock check result is clean."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/10.0/double_clock_*.rpt"
  waivers:
    value: 2
    waive_items:
      - name: "at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold"
        reason: "Waived per design review - clock gating cell has controlled double clocking for power management"
      - name: "func_rcss_0p675v_125c_pcss_cmax_pcff3_setup"
        reason: "Approved exception - clock mux select signal has intentional multi-domain clocking with synchronizer"
```

**Check Behavior:**
Type 4 = Type 1 + waiver support.
Same boolean check as Type 1 (no pattern_items), plus waiver classification:
- Match violations against waive_items
- Unwaived violations → ERROR
- Waived violations → INFO with [WAIVER] tag
- Unused waivers → WARN with [WAIVER] tag
PASS if all violations are waived.

**Sample Output:**
```
Status: PASS
Reason: All items waived
INFO01 (Waived):
  - View 'at_speed_rcff_0p825v_125c_pcff_cmin_pcff3_hold' | core/clk_gate_inst/CK | Transition: rise | Reverse Swing: 1.234e-09 | Reverse Slope: 2.456e-10 [WAIVER]
  - View 'func_rcss_0p675v_125c_pcss_cmax_pcff3_setup' | top/u_ctrl/clk_mux/SEL | Transition: fall | Reverse Swing: 3.456e-09 | Reverse Slope: 5.678e-10 [WAIVER]
```

---

## Testing

### Test Commands

```powershell
# Create test snapshots for all types
python common/regression_testing/create_all_snapshots.py --modules 10.0_STA_DCD_CHECK --checkers IMP-10-0-0-15 --force

# Run individual tests
python IMP-10-0-0-15.py
```

---

## Notes

- **Multi-file Aggregation**: Checker aggregates violations from all `double_clock_*.rpt` files matching the glob pattern
- **View Context Tracking**: Each violation is associated with its timing view (corner) for accurate reporting
- **Clean Report Detection**: Reports with column headers but no violation entries are considered clean (PASS)
- **Scientific Notation**: Reverse swing/slope values may use scientific notation (e.g., 1.234e-09) - parser handles both formats
- **Truncation Handling**: If reports are truncated (e.g., "# Limit to 10KB"), checker flags as potentially incomplete
- **State Machine Parsing**: Uses multi-state parser to handle complex report structure with multiple views per file
- **Metastability Risk**: Double clocking violations indicate potential metastability issues requiring synchronizers or design fixes
- **Waiver Granularity**: Waivers match exact instance/pin paths - use full hierarchical path for precise waiver targeting