# IMP-15-0-0-04: Confirm there is no issue about CNOD check if CNOD check is needed.

## Overview

**Check ID:** IMP-15-0-0-04  
**Description:** Confirm there is no issue about CNOD check if CNOD check is needed.  
**Category:** Physical Verification - ESD/CNOD Compliance  
**Input Files:** `${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep`

This checker validates CNOD (Cell Near Oxide Definition) compliance by analyzing physical verification reports. CNOD checks ensure that cells are not placed too close to oxide regions, which can cause reliability issues. The checker parses CNOD percentage reports to identify violations, extract summary statistics, and verify that all cells meet the required distance thresholds from oxide regions.

---

## Check Logic

### Input Parsing

The checker parses CNOD percentage reports generated by physical verification tools. The report contains summary statistics (total cells checked, violation counts, pass/fail status) and detailed violation entries with cell names, locations, and distance measurements.

**Key Patterns:**

```python
# Pattern 1: Pass/Fail status indicator - CHECK(s) PASS
pattern1 = r'CHECK\(s\)\s+PASS'
# Example: "CHECK(s) PASS"

# Pattern 2: CNOD violation entry with cell name and distance
pattern2 = r'(?:CNOD\s+)?(?:Violation|ERROR|Warning)\s*:?\s*Cell\s+([\w\/]+)\s+.*?distance\s*[:=]?\s*([\d.]+)\s*(um|nm)?'
# Example: "CNOD Violation: Cell INVX1/U123 distance = 0.05um (threshold: 0.1um)"

# Pattern 3: Summary statistics - total cells checked
pattern3 = r'Total\s+(?:cells?|instances?)\s*(?:checked|analyzed)?\s*[:=]?\s*(\d+)'
# Example: "Total cells checked: 15234"

# Pattern 4: Violation count summary
pattern4 = r'(?:Total\s+)?(?:CNOD\s+)?(?:Violations?|Errors?)\s*[:=]?\s*(\d+)'
# Example: "CNOD Violations: 23"

# Pattern 5: Cell location coordinates
pattern5 = r'(?:Location|Coordinate|Position)\s*[:=]?\s*\(?\s*([\d.]+)\s*,\s*([\d.]+)\s*\)?'
# Example: "Location: (123.45, 678.90)"

# Pattern 6: Percentage calculation
pattern6 = r'Percentage\s*:\s*([\d.]+)%'
# Example: "Percentage: 0.00%"
```

### Detection Logic

1. **File Validation**: Check if the CNOD report file exists and is not empty
2. **Header Detection**: Identify report header and skip comment lines (starting with #, //, or *)
3. **Pass/Fail Status Check**: Search for "CHECK(s) PASS" pattern in the report
   - **PASS**: If "CHECK(s) PASS" pattern is found
   - **FAIL**: If "CHECK(s) PASS" pattern is NOT found
4. **Summary Extraction**: Parse summary section to extract:
   - Total cells analyzed
   - Total CNOD violations found
   - Overall pass/fail status
   - Violation percentage
5. **Violation Parsing**: For each violation entry, extract:
   - Cell instance name
   - Location coordinates (x, y)
   - Actual distance to oxide region
   - Required threshold distance
   - Violation severity (if available)
6. **Edge Cases**:
   - Empty file → Report as INFO: "CNOD check not performed or report empty"
   - No "CHECK(s) PASS" found → Report as FAIL
   - Missing summary → Count violations manually from detail lines

---

## Output Behavior (CRITICAL - Determines Type 2/3 Logic!)

**Check Mode:** `status_check`

Choose ONE mode based on what pattern_items represents:

### Mode 1: `existence_check` - 存在性检查
**Use when:** pattern_items are items that SHOULD EXIST in input files

```
pattern_items: ["item_A", "item_B", "item_C"]
Input file contains: item_A, item_B

Result:
  found_items:   item_A, item_B    ← Pattern found in file
  missing_items: item_C            ← Pattern NOT found in file

PASS: All pattern_items found in file
FAIL: Some pattern_items not found in file
```

### Mode 2: `status_check` - 状态检查  
**Use when:** pattern_items are items to CHECK STATUS, only output matched items

```
pattern_items: ["port_A", "port_B"]
Input file contains: port_A(fixed), port_B(unfixed), port_C(unfixed)

Result:
  found_items:   port_A            ← Pattern matched AND status correct
  missing_items: port_B            ← Pattern matched BUT status wrong
  (port_C not output - not in pattern_items)

PASS: All matched items have correct status
FAIL: Some matched items have wrong status (or pattern not matched)
```

**Selected Mode for this checker:** `status_check`

**Rationale:** This checker validates CNOD violation status by searching for "CHECK(s) PASS" pattern in the report. The checker verifies CNOD compliance status based on the presence of this pass indicator. Only items matching the pattern_items are reported, with their pass/fail status determined by whether the "CHECK(s) PASS" pattern is found.

---

## Output Descriptions (CRITICAL - Code Generator Uses These!)

This section defines the output strings used by `build_complete_output()` in the checker code.
**Fill in these values based on the check logic above.**

```python
# ⚠️ CRITICAL: Description & Reason parameter usage by Type (API-026)
# Both DESC and REASON constants are split by Type for semantic clarity:
#   Type 1/4 (Boolean): Use DESC_TYPE1_4 & REASON_TYPE1_4 (emphasize "found/not found")
#   Type 2/3 (Pattern): Use DESC_TYPE2_3 & REASON_TYPE2_3 (emphasize "matched/satisfied")

# Item description for this checker
item_desc = "CNOD check status"

# PASS case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_desc_type1_4 = "CNOD check report found with CHECK(s) PASS status"
# Type 2/3: Pattern checks - emphasize "matched/satisfied" (pattern validation)
found_desc_type2_3 = "CHECK(s) PASS pattern matched - CNOD requirements satisfied"

# PASS reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_reason_type1_4 = "CNOD report found with CHECK(s) PASS status indicating all cells meet distance requirements"
# Type 2/3: Pattern checks - emphasize pattern matching terms (matched|satisfied|validated|compliant|fulfilled)
found_reason_type2_3 = "CHECK(s) PASS pattern matched in report - all CNOD distance requirements satisfied and validated"

# FAIL case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_desc_type1_4 = "CNOD check report missing CHECK(s) PASS status"
# Type 2/3: Pattern checks - emphasize pattern mismatch
missing_desc_type2_3 = "CHECK(s) PASS pattern not found - CNOD violations detected"

# FAIL reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_reason_type1_4 = "CHECK(s) PASS status not found in CNOD report - violations exist or check incomplete"
# Type 2/3: Pattern checks - emphasize pattern mismatch terms (not satisfied|missing|failed)
missing_reason_type2_3 = "CHECK(s) PASS pattern not satisfied - CNOD distance requirements failed or violations require fixes"

# WAIVED case descriptions (ALL Types need these)
# Type 1/2 use in waiver=0 mode for waive_items comments
# Type 3/4 use for actual waived violations
waived_desc = "CNOD violations waived per design approval"

# WAIVED reasons (Type 3/4 ONLY - actual waiver logic)
waived_base_reason = "CNOD violation waived - approved by design team with documented justification"

# UNUSED waivers (Type 3/4 ONLY)
unused_desc = "Unused CNOD waiver entries"
unused_waiver_reason = "Waiver entry not matched - no corresponding CNOD violation found in report"
```

### INFO01/ERROR01 Display Format

```
INFO01 (Clean/Pass items):
  Format: "CNOD Check: PASSED | File: <filename>"
  Example: "CNOD Check: PASSED | File: cnod_perc.rep"

ERROR01 (Violation/Fail items):
  Format: "CNOD Check: FAILED | File: <filename>"
  Example: "CNOD Check: FAILED | File: cnod_perc.rep"
```

---

## Type 1: Boolean Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-15-0-0-04:
  description: "Confirm there is no issue about CNOD check if CNOD check is needed."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep"
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 1 performs custom boolean checks (file exists? config valid?).
PASS/FAIL based on checker's own validation logic - searches for "CHECK(s) PASS" pattern.

**Sample Output (PASS):**
```
Status: PASS
Reason: CNOD report found with CHECK(s) PASS status indicating all cells meet distance requirements
INFO01:
  - CNOD Check: PASSED | File: cnod_perc.rep
```

**Sample Output (FAIL):**
```
Status: FAIL
Reason: CHECK(s) PASS status not found in CNOD report - violations exist or check incomplete
ERROR01:
  - CNOD Check: FAILED | File: cnod_perc.rep
```

### Type 1 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-15-0-0-04:
  description: "Confirm there is no issue about CNOD check if CNOD check is needed."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep"
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: CNOD violations are informational only for this legacy design"
      - "Note: Design uses older technology node where CNOD spacing rules are relaxed"
      - "Justification: All violations reviewed and approved by reliability team"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 1 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL violations force converted: FAIL→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (violations shown as INFO for tracking)
- Used when: Check is informational only, violations expected/acceptable

**Sample Output (PASS with violations):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All violations waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: CNOD violations are informational only for this legacy design"
  - "Note: Design uses older technology node where CNOD spacing rules are relaxed"
  - "Justification: All violations reviewed and approved by reliability team"
INFO02 ([WAIVED_AS_INFO] - violations converted to PASS, shown as INFO):
  - CNOD Check: FAILED | File: cnod_perc.rep [WAIVED_AS_INFO]
```

---

## Type 2: Value Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-15-0-0-04:
  description: "Confirm there is no issue about CNOD check if CNOD check is needed."
  requirements:
    value: 1
    pattern_items:
      - "cnod_perc.rep"
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep"
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 2 searches pattern_items in input files and checks for "CHECK(s) PASS" status.
PASS/FAIL depends on check purpose:
- Violation Check: PASS if "CHECK(s) PASS" found (no violations)
- Requirement Check: PASS if missing_items empty (all requirements met)

**Sample Output (PASS):**
```
Status: PASS
Reason: CHECK(s) PASS pattern matched in report - all CNOD distance requirements satisfied and validated
INFO01:
  - CNOD Check: PASSED | File: cnod_perc.rep
```

**Sample Output (FAIL):**
```
Status: FAIL
Reason: CHECK(s) PASS pattern not satisfied - CNOD distance requirements failed or violations require fixes
ERROR01:
  - CNOD Check: FAILED | File: cnod_perc.rep
```

### Type 2 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-15-0-0-04:
  description: "Confirm there is no issue about CNOD check if CNOD check is needed."
  requirements:
    value: 1
    pattern_items:
      - "cnod_perc.rep"
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep"
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: CNOD pattern check is informational only for these specific cell types"
      - "Note: INVX1 and NAND2X2 cells have known CNOD issues that are acceptable per design rules"
      - "Justification: Pattern mismatches expected in test mode and do not require fixes"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 2 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL errors/mismatches force converted: ERROR→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (errors shown as INFO for tracking)
- Used when: Pattern check is informational, mismatches expected

**Sample Output (PASS with mismatches):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All mismatches waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: CNOD pattern check is informational only for these specific cell types"
  - "Note: INVX1 and NAND2X2 cells have known CNOD issues that are acceptable per design rules"
  - "Justification: Pattern mismatches expected in test mode and do not require fixes"
INFO02 ([WAIVED_AS_INFO] - errors converted to PASS, shown as INFO):
  - CNOD Check: FAILED | File: cnod_perc.rep [WAIVED_AS_INFO]
```

---

## Type 3: Value Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-15-0-0-04:
  description: "Confirm there is no issue about CNOD check if CNOD check is needed."
  requirements:
    value: 1
    pattern_items:
      - "cnod_perc.rep"
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep"
  waivers:
    value: 2
    waive_items:
      - name: "cnod_perc.rep"
        reason: "Waived per design review - CNOD violations acceptable for this legacy design"
```

**Check Behavior:**
Type 3 = Type 2 + waiver support.
Same pattern search logic as Type 2 (checks for "CHECK(s) PASS"), plus waiver classification:
- Match found_items against waive_items
- Unwaived items → ERROR (need fix)
- Waived items → INFO with [WAIVER] tag (approved)
- Unused waivers → WARN with [WAIVER] tag
PASS if all found_items (violations) are waived.

**Sample Output (with waived items):**
```
Status: PASS
Reason: All violations waived
INFO01 (Waived):
  - CNOD Check: FAILED | File: cnod_perc.rep [WAIVER]
WARN01 (Unused Waivers):
  - (none)
```

---

## Type 4: Boolean Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-15-0-0-04:
  description: "Confirm there is no issue about CNOD check if CNOD check is needed."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - "${CHECKLIST_ROOT}/IP_project_folder/reports/15.0/cnod_perc.rep"
  waivers:
    value: 2
    waive_items:
      - name: "cnod_perc.rep"
        reason: "Waived per design review - CNOD violations acceptable for this legacy design"
```

**Check Behavior:**
Type 4 = Type 1 + waiver support.
Same boolean check as Type 1 (no pattern_items, searches for "CHECK(s) PASS"), plus waiver classification:
- Match violations against waive_items
- Unwaived violations → ERROR
- Waived violations → INFO with [WAIVER] tag
- Unused waivers → WARN with [WAIVER] tag
PASS if all violations are waived.

**Sample Output:**
```
Status: PASS
Reason: All items waived
INFO01 (Waived):
  - CNOD Check: FAILED | File: cnod_perc.rep [WAIVER]
```

---

## Testing

### Test Commands

```powershell
# Create test snapshots for all types
python common/regression_testing/create_all_snapshots.py --modules 15.0_ESD_PERC_CHECK --checkers IMP-15-0-0-04 --force

# Run individual tests
python IMP-15-0-0-04.py
```

---

## Notes

- **CHECK(s) PASS Pattern**: The primary pass/fail determination is based on finding the "CHECK(s) PASS" pattern in the report. If this pattern is found, the check passes; otherwise, it fails.
- **Empty Report Handling**: If the CNOD report file is empty or contains only comments, the checker reports this as INFO rather than FAIL, since it may indicate CNOD check was not required for this design
- **Unit Conversion**: The checker handles both 'um' and 'nm' distance units and normalizes them for consistent comparison
- **Multiple File Support**: If multiple CNOD reports exist (e.g., per block or per corner), the checker aggregates violations across all files while maintaining traceability to source files
- **Threshold Extraction**: The checker attempts to extract both actual distance and required threshold from violation messages to provide complete context
- **Coordinate Precision**: Cell location coordinates are preserved with full precision for accurate physical debugging
- **Summary vs Detail**: The checker prioritizes the "CHECK(s) PASS" pattern but also extracts summary statistics (total cells, violation count, percentage) and falls back to counting individual violation entries if summary is missing
- **Technology Dependency**: CNOD requirements vary by technology node - ensure threshold values in reports match your design rules