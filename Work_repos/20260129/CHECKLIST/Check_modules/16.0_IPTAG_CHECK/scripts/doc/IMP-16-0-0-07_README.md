# IMP-16-0-0-07: Confirm the Final GDS have the IPTAG information?

## Overview

**Check ID:** IMP-16-0-0-07  
**Description:** Confirm the Final GDS have the IPTAG information?  
**Category:** IPTAG Verification  
**Input Files:** 
- `${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv`

This checker verifies that the final GDS file contains proper IPTAG information for all IP blocks. It parses the CSV report generated by the IP_CHECKER tool to validate that vendor, product, version, and instance information are correctly embedded in the GDS. The checker counts unique vendors, products, and tagged instances, and reports any missing or malformed IPTAG entries.

---

## Check Logic

### Input Parsing

The checker parses a CSV file generated by IP_CHECKER tool containing IPTAG information extracted from GDS files. The CSV includes metadata about the tool and data rows with vendor/product/version/instance information.

**Key Patterns:**

```python
# Pattern 1: IP_checker tool path and version
pattern1 = r'^IP_checker filename\s*:\s*(.+?)\s*$'
# Example: "IP_checker filename : /local/method/scripts/IP_checker/ipg_release_001/IP_TAG_Tool_v2d3_Cadence/IP_CHECKER/RHE4_Linux/IP_checker.Linux"

# Pattern 2: CSV header validation
pattern2 = r'^GDS\s*,\s*Vendor\s*,\s*Product\s*,\s*Version\s*,\s*Metric\s*,\s*Instance\s*,\s*Instance_tag'
# Example: "GDS                 ,Vendor    ,Product   ,Version   ,Metric    ,Instance  ,Instance_tag"

# Pattern 3: IPTAG data row (foundry IP)
pattern3 = r'^([^,]+\.gds),"([^"]+)","?([^"]+)"?,"?([^"]+)"?,([0-9.]+),([^,]+),"?([^"]+)"?\s*$'
# Example: 'cdn_hs_phy_top.wIPTAG.gds,"Taiwan Semiconductor Manufacturing Corp.",tcbn05_bwph280l6p57cnod_base_lvt,"110a",0.096,AIOI21KAD1BWP280H6P57CNODLVT,"AIOI21KAD1BWP280H6P57CNODLVT"'

# Pattern 4: Cadence IP entries (design owner)
pattern4 = r'^([^,]+\.gds),"Cadence Design Systems, Inc\."'
# Example: 'cdn_hs_phy_top.wIPTAG.gds,"Cadence Design Systems, Inc.",HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R,"R100",0.0,cdn_hs_phy_top,"cdn_hs_phy_top"'
```

### Detection Logic

1. **Read and validate CSV structure:**
   - Extract IP_checker tool path/version from first line
   - Locate and validate CSV header line
   - Skip comment lines and empty rows

2. **Parse IPTAG data rows:**
   - Extract GDS filename, vendor, product, version, metric, instance, instance_tag
   - Handle quoted fields containing commas/spaces
   - Distinguish between foundry IP (TSMC) and design owner IP (Cadence)

3. **Aggregate statistics:**
   - Count unique GDS files processed
   - Count unique vendors across all entries
   - Count unique products per vendor
   - Count total instances with IPTAG information

4. **Detect violations:**
   - Missing IPTAG data (empty CSV or no data rows)
   - Malformed CSV entries (incorrect column count, invalid format)
   - Instances without proper vendor/product/version tags
   - Missing header line or invalid CSV structure

5. **Generate output:**
   - INFO01: Summary statistics for each GDS file (vendor count, product count, instance count)
   - ERROR01: Missing or malformed IPTAG entries with specific error descriptions

---

## Output Behavior (CRITICAL - Determines Type 2/3 Logic!)

**Check Mode:** `existence_check`

Choose ONE mode based on what pattern_items represents:

### Mode 1: `existence_check` - 存在性检查
**Use when:** pattern_items are items that SHOULD EXIST in input files

```
pattern_items: ["item_A", "item_B", "item_C"]
Input file contains: item_A, item_B

Result:
  found_items:   item_A, item_B    ← Pattern found in file
  missing_items: item_C            ← Pattern NOT found in file

PASS: All pattern_items found in file
FAIL: Some pattern_items not found in file
```

### Mode 2: `status_check` - 状态检查  
**Use when:** pattern_items are items to CHECK STATUS, only output matched items

```
pattern_items: ["port_A", "port_B"]
Input file contains: port_A(fixed), port_B(unfixed), port_C(unfixed)

Result:
  found_items:   port_A            ← Pattern matched AND status correct
  missing_items: port_B            ← Pattern matched BUT status wrong
  (port_C not output - not in pattern_items)

PASS: All matched items have correct status
FAIL: Some matched items have wrong status (or pattern not matched)
```

**Selected Mode for this checker:** `existence_check`

**Rationale:** This checker verifies that IPTAG information exists in the GDS file. It checks for the presence of required IPTAG data (vendor, product, version, instances) in the CSV report. The check passes if all expected IPTAG entries are found and properly formatted, and fails if any required information is missing or malformed.

---

## Output Descriptions (CRITICAL - Code Generator Uses These!)

This section defines the output strings used by `build_complete_output()` in the checker code.
**Fill in these values based on the check logic above.**

```python
# ⚠️ CRITICAL: Description & Reason parameter usage by Type (API-026)
# Both DESC and REASON constants are split by Type for semantic clarity:
#   Type 1/4 (Boolean): Use DESC_TYPE1_4 & REASON_TYPE1_4 (emphasize "found/not found")
#   Type 2/3 (Pattern): Use DESC_TYPE2_3 & REASON_TYPE2_3 (emphasize "matched/satisfied")

# Item description for this checker
item_desc = "Confirm the Final GDS have the IPTAG information?"

# PASS case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_desc_type1_4 = "IPTAG information found in final GDS"
# Type 2/3: Pattern checks - emphasize "matched/satisfied" (pattern validation)
found_desc_type2_3 = "All required IPTAG entries matched and validated"

# PASS reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_reason_type1_4 = "IPTAG information found in final GDS with valid vendor/product/version data"
# Type 2/3: Pattern checks - emphasize pattern matching terms (matched|satisfied|validated|compliant|fulfilled)
found_reason_type2_3 = "All required IPTAG entries matched and validated in GDS file"

# FAIL case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_desc_type1_4 = "IPTAG information not found or incomplete in final GDS"
# Type 2/3: Pattern checks - emphasize pattern mismatch
missing_desc_type2_3 = "Required IPTAG entries not satisfied or missing from GDS"

# FAIL reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_reason_type1_4 = "IPTAG information not found or incomplete - missing vendor/product/version data"
# Type 2/3: Pattern checks - emphasize pattern mismatch terms (not satisfied|missing|failed)
missing_reason_type2_3 = "Required IPTAG entries not satisfied - missing or malformed data in GDS"

# WAIVED case descriptions (ALL Types need these)
# Type 1/2 use in waiver=0 mode for waive_items comments
# Type 3/4 use for actual waived violations
waived_desc = "IPTAG violations waived"

# WAIVED reasons (Type 3/4 ONLY - actual waiver logic)
waived_base_reason = "IPTAG violation waived per design team approval"

# UNUSED waivers (Type 3/4 ONLY)
unused_desc = "Unused IPTAG waiver entries"
unused_waiver_reason = "Waiver not matched - no corresponding IPTAG violation found"
```

### INFO01/ERROR01 Display Format

```
INFO01 (Clean/Pass items):
  Format: "GDS: [gds_filename] | Vendors: [count] | Products: [count] | Tagged Instances: [count]"
  Example: "GDS: cdn_hs_phy_top.wIPTAG.gds | Vendors: 2 | Products: 15 | Tagged Instances: 1234"

ERROR01 (Violation/Fail items):
  Format: "Instance: [instance_name] | Issue: [error_description] | GDS: [gds_file]"
  Example: "Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Missing vendor information | GDS: cdn_hs_phy_top.wIPTAG.gds"
```

---

## Type 1: Boolean Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-07:
  description: "Confirm the Final GDS have the IPTAG information?"
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 1 performs custom boolean checks (file exists? config valid?).
PASS/FAIL based on checker's own validation logic.

**Sample Output (PASS):**
```
Status: PASS
Reason: IPTAG information found in final GDS with valid vendor/product/version data
INFO01:
  - GDS: cdn_hs_phy_top.wIPTAG.gds | Vendors: 2 | Products: 15 | Tagged Instances: 1234
```

**Sample Output (FAIL):**
```
Status: FAIL
Reason: IPTAG information not found or incomplete - missing vendor/product/version data
ERROR01:
  - Instance: cdn_hs_phy_top | Issue: Missing IPTAG data - no vendor information found | GDS: cdn_hs_phy_top.wIPTAG.gds
  - Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Malformed CSV entry - invalid version format | GDS: cdn_hs_phy_top.wIPTAG.gds
```

### Type 1 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-16-0-0-07:
  description: "Confirm the Final GDS have the IPTAG information?"
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: This check is informational only - IPTAG verification is performed separately by IP release flow"
      - "Note: Missing IPTAG entries are expected for legacy IP blocks and do not block tapeout"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 1 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL violations force converted: FAIL→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (violations shown as INFO for tracking)
- Used when: Check is informational only, violations expected/acceptable

**Sample Output (PASS with violations):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All violations waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: This check is informational only - IPTAG verification is performed separately by IP release flow"
  - "Note: Missing IPTAG entries are expected for legacy IP blocks and do not block tapeout"
INFO02 ([WAIVED_AS_INFO] - violations converted to PASS, shown as INFO):
  - Instance: cdn_hs_phy_top | Issue: Missing IPTAG data - no vendor information found | GDS: cdn_hs_phy_top.wIPTAG.gds [WAIVED_AS_INFO]
  - Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Malformed CSV entry - invalid version format | GDS: cdn_hs_phy_top.wIPTAG.gds [WAIVED_AS_INFO]
```

---

## Type 2: Value Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-07:
  description: "Confirm the Final GDS have the IPTAG information?"
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top.wIPTAG.gds"
      - "Taiwan Semiconductor Manufacturing Corp."
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 2 searches pattern_items in input files.
PASS/FAIL depends on check purpose:
- Violation Check: PASS if found_items empty (no violations)
- Requirement Check: PASS if missing_items empty (all requirements met)

**Sample Output (PASS):**
```
Status: PASS
Reason: All required IPTAG entries matched and validated in GDS file
INFO01:
  - GDS: cdn_hs_phy_top.wIPTAG.gds | Vendors: 2 | Products: 15 | Tagged Instances: 1234
  - Vendor: Taiwan Semiconductor Manufacturing Corp. | Products: 12 | Instances: 1200
```

### Type 2 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-16-0-0-07:
  description: "Confirm the Final GDS have the IPTAG information?"
  requirements:
    value: 0
    pattern_items:
      - "cdn_hs_phy_top.wIPTAG.gds"
      - "Taiwan Semiconductor Manufacturing Corp."
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: This check is informational only - IPTAG pattern matching is advisory for this release"
      - "Note: Pattern mismatches are expected for third-party IP blocks and do not require fixes"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 2 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL errors/mismatches force converted: ERROR→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (errors shown as INFO for tracking)
- Used when: Pattern check is informational, mismatches expected

**Sample Output (PASS with mismatches):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All mismatches waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: This check is informational only - IPTAG pattern matching is advisory for this release"
  - "Note: Pattern mismatches are expected for third-party IP blocks and do not require fixes"
INFO02 ([WAIVED_AS_INFO] - errors converted to PASS, shown as INFO):
  - GDS: cdn_hs_phy_top.wIPTAG.gds | Issue: Missing expected vendor pattern | Expected: Taiwan Semiconductor Manufacturing Corp. [WAIVED_AS_INFO]
```

---

## Type 3: Value Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-07:
  description: "Confirm the Final GDS have the IPTAG information?"
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top.wIPTAG.gds"
      - "Taiwan Semiconductor Manufacturing Corp."
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 2
    waive_items:
      - name: "Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Missing version information | GDS: cdn_hs_phy_top.wIPTAG.gds"
        reason: "Waived - legacy IP block uses older IPTAG format without version field"
      - name: "Instance: cdn_hs_phy_analog_block | Issue: Vendor name mismatch | GDS: cdn_hs_phy_top.wIPTAG.gds"
        reason: "Waived - third-party IP uses alternative vendor naming convention per license agreement"
```

**Check Behavior:**
Type 3 = Type 2 + waiver support.
Same pattern search logic as Type 2, plus waiver classification:
- Match found_items against waive_items
- Unwaived items → ERROR (need fix)
- Waived items → INFO with [WAIVER] tag (approved)
- Unused waivers → WARN with [WAIVER] tag
PASS if all found_items (violations) are waived.

**Sample Output (with waived items):**
```
Status: PASS
Reason: All violations waived
INFO01 (Waived):
  - Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Missing version information | GDS: cdn_hs_phy_top.wIPTAG.gds [WAIVER]
  - Instance: cdn_hs_phy_analog_block | Issue: Vendor name mismatch | GDS: cdn_hs_phy_top.wIPTAG.gds [WAIVER]
WARN01 (Unused Waivers):
  - Instance: obsolete_block | Issue: Missing IPTAG | GDS: old_design.gds: Waiver not matched - no corresponding IPTAG violation found
```

---

## Type 4: Boolean Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-07:
  description: "Confirm the Final GDS have the IPTAG information?"
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 2
    waive_items:
      - name: "Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Missing version information | GDS: cdn_hs_phy_top.wIPTAG.gds"
        reason: "Waived - legacy IP block uses older IPTAG format without version field"
      - name: "Instance: cdn_hs_phy_analog_block | Issue: Vendor name mismatch | GDS: cdn_hs_phy_top.wIPTAG.gds"
        reason: "Waived - third-party IP uses alternative vendor naming convention per license agreement"
```

**Check Behavior:**
Type 4 = Type 1 + waiver support.
Same boolean check as Type 1 (no pattern_items), plus waiver classification:
- Match violations against waive_items
- Unwaived violations → ERROR
- Waived violations → INFO with [WAIVER] tag
- Unused waivers → WARN with [WAIVER] tag
PASS if all violations are waived.

**Sample Output:**
```
Status: PASS
Reason: All items waived
INFO01 (Waived):
  - Instance: AIOI21KAD1BWP280H6P57CNODLVT | Issue: Missing version information | GDS: cdn_hs_phy_top.wIPTAG.gds [WAIVER]
  - Instance: cdn_hs_phy_analog_block | Issue: Vendor name mismatch | GDS: cdn_hs_phy_top.wIPTAG.gds [WAIVER]
```

---

## Testing

### Test Commands

```powershell
# Create test snapshots for all types
python common/regression_testing/create_all_snapshots.py --modules 16.0_IPTAG_CHECK --checkers IMP-16-0-0-07 --force

# Run individual tests
python IMP-16-0-0-07.py
```

---

## Notes

- This checker follows the same CSV processing pattern as IMP-16-0-0-01 for PHY IPTAG handling
- Block IPTAG processing is identical to PHY IPTAG processing per user requirements
- The CSV file is generated by IP_CHECKER tool (IP_TAG_Tool_v2d3_Cadence)
- Supports multiple GDS files in a single CSV report
- Distinguishes between foundry IP (TSMC) and design owner IP (Cadence)
- Handles quoted CSV fields containing commas and spaces
- Validates both header structure and data row format
- Reports per-GDS statistics and per-instance violations
- Empty CSV files or missing headers trigger ERROR01 violations