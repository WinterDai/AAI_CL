# IMP-16-0-0-02: Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)

## Overview

**Check ID:** IMP-16-0-0-02  
**Description:** Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)  
**Category:** IPTAG Verification  
**Input Files:** `${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv`

This checker verifies IP tagging compliance for PHY deliveries by parsing the IP_CHECKER tool's CSV output. It validates that:
- **Hard PHY delivery**: PHY-level IPTAG must be present, block-level IPTAG must NOT be present
- **FIRM PHY delivery**: Block-level IPTAG must be present, PHY-level IPTAG must NOT be present
- **ERROR**: Both PHY-level and block-level IPTAGs are missing

The checker processes the CSV report to extract IPTAG information for both the PHY-level (*phy) and block-level (*block) entries, determining delivery type based on which IPTAG is present.

---

## Check Logic

### Input Parsing
The checker parses the CSV file generated by IP_CHECKER tool, which contains GDS instance information with vendor, product, version, and IPTAG data.

**Key Patterns:**
```python
# Pattern 1: CSV header validation
header_pattern = r'^GDS\s*,\s*Vendor\s*,\s*Product\s*,\s*Version\s*,\s*Metric\s*,\s*Instance\s*,\s*Instance_tag'
# Example: "GDS                 ,Vendor    ,Product   ,Version   ,Metric    ,Instance  ,Instance_tag"

# Pattern 2: PHY-level IPTAG entry (*phy line - for Hard PHY delivery)
phy_iptag_pattern = r'[^,]*phy[^,]*\.wIPTAG\.gds,"([^"]+)","?([^,"]+)"?,"?([^,"]+)"?,[^,]+,([^,]+),"?([^,"\n]+)"?'
# Example: 'cdn_hs_phy_top.wIPTAG.gds,"Cadence Design Systems, Inc.",HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R,"R100",0.0,cdn_hs_phy_top,"cdn_hs_phy_top"'
# Extracts: Vendor, Product, Version, Instance, Instance_tag

# Pattern 3: Block-level IPTAG entry (*block line - for FIRM PHY delivery)
block_iptag_pattern = r'[^,]*block[^,]*\.wIPTAG\.gds,"([^"]+)","?([^,"]+)"?,"?([^,"]+)"?,[^,]+,([^,]+),"?([^,"\n]+)"?'
# Example: 'cdn_hs_block_top.wIPTAG.gds,"Cadence Design Systems, Inc.",HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R,"R100",0.0,cdn_hs_block_top,"cdn_hs_block_top"'
# Extracts: Vendor, Product, Version, Instance, Instance_tag

# Pattern 4: Generic CSV data row parser (fallback)
csv_row_pattern = r'^([^,]+),"?([^"]+)"?,"?([^,"]+)"?,"?([^,"]+)"?,([^,]+),([^,]+),"?([^,"\n]+)"?'
# Extracts: GDS, Vendor, Product, Version, Metric, Instance, Instance_tag
```

### Detection Logic
1. **Parse CSV file**: Read and validate CSV structure using header pattern
2. **Extract PHY-level IPTAG**: Search for *phy line entry
   - If found: Extract vendor, product, version, instance_tag information
   - Store PHY IPTAG presence status
3. **Extract Block-level IPTAG**: Search for *block line entry
   - If found: Extract vendor, product, version, instance_tag information
   - Store Block IPTAG presence status
4. **Classify by delivery type**:
   - **Hard PHY delivery**: PHY IPTAG exists AND Block IPTAG does NOT exist
   - **FIRM PHY delivery**: Block IPTAG exists AND PHY IPTAG does NOT exist
   - **ERROR**: Both PHY IPTAG and Block IPTAG do NOT exist
5. **Generate results**:
   - INFO01: Summary of found IPTAGs and delivery type classification
   - ERROR01: Missing IPTAG violations or invalid delivery type configuration

---

## Output Behavior (CRITICAL - Determines Type 2/3 Logic!)

**Check Mode:** `status_check`

Choose ONE mode based on what pattern_items represents:

### Mode 1: `existence_check` - 存在性检查
**Use when:** pattern_items are items that SHOULD EXIST in input files

```
pattern_items: ["item_A", "item_B", "item_C"]
Input file contains: item_A, item_B

Result:
  found_items:   item_A, item_B    ← Pattern found in file
  missing_items: item_C            ← Pattern NOT found in file

PASS: All pattern_items found in file
FAIL: Some pattern_items not found in file
```

### Mode 2: `status_check` - 状态检查  
**Use when:** pattern_items are items to CHECK STATUS, only output matched items

```
pattern_items: ["port_A", "port_B"]
Input file contains: port_A(fixed), port_B(unfixed), port_C(unfixed)

Result:
  found_items:   port_A            ← Pattern matched AND status correct
  missing_items: port_B            ← Pattern matched BUT status wrong
  (port_C not output - not in pattern_items)

PASS: All matched items have correct status
FAIL: Some matched items have wrong status (or pattern not matched)
```

**Selected Mode for this checker:** `status_check`

**Rationale:** This checker validates IPTAG status for specific instances (PHY and Block entries). It checks whether the correct IPTAG exists based on delivery type, not whether arbitrary patterns exist in the file. The check focuses on the correctness of IPTAG data for known instances rather than searching for unknown items.

---

## Output Descriptions (CRITICAL - Code Generator Uses These!)

This section defines the output strings used by `build_complete_output()` in the checker code.
**Fill in these values based on the check logic above.**

```python
# ⚠️ CRITICAL: Description & Reason parameter usage by Type (API-026)
# Both DESC and REASON constants are split by Type for semantic clarity:
#   Type 1/4 (Boolean): Use DESC_TYPE1_4 & REASON_TYPE1_4 (emphasize "found/not found")
#   Type 2/3 (Pattern): Use DESC_TYPE2_3 & REASON_TYPE2_3 (emphasize "matched/satisfied")

# Item description for this checker
item_desc = "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"

# PASS case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_desc_type1_4 = "Valid delivery type detected with correct IPTAG configuration"
# Type 2/3: Pattern checks - emphasize "matched/satisfied" (pattern validation)
found_desc_type2_3 = "IPTAG configuration matched expected delivery type pattern"

# PASS reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_reason_type1_4 = "Hard PHY delivery: PHY IPTAG found, Block IPTAG not found; OR FIRM PHY delivery: Block IPTAG found, PHY IPTAG not found"
# Type 2/3: Pattern checks - emphasize pattern matching terms (matched|satisfied|validated|compliant|fulfilled)
found_reason_type2_3 = "IPTAG pattern validated for delivery type - Hard PHY or FIRM PHY configuration satisfied"

# FAIL case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_desc_type1_4 = "Invalid IPTAG configuration or missing required IPTAGs"
# Type 2/3: Pattern checks - emphasize pattern mismatch
missing_desc_type2_3 = "IPTAG pattern does not match any valid delivery type"

# FAIL reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_reason_type1_4 = "Both PHY IPTAG and Block IPTAG not found - cannot determine delivery type"
# Type 2/3: Pattern checks - emphasize pattern mismatch terms (not satisfied|missing|failed)
missing_reason_type2_3 = "IPTAG pattern not satisfied - both PHY and Block IPTAGs missing or invalid configuration"

# WAIVED case descriptions (ALL Types need these)
# Type 1/2 use in waiver=0 mode for waive_items comments
# Type 3/4 use for actual waived violations
waived_desc = "IPTAG configuration violations waived per design approval"

# WAIVED reasons (Type 3/4 ONLY - actual waiver logic)
waived_base_reason = "IPTAG missing or invalid configuration - waived per IP delivery team approval"

# UNUSED waivers (Type 3/4 ONLY)
unused_desc = "Unused IPTAG waiver entries"
unused_waiver_reason = "Waiver not matched - no corresponding IPTAG violation found for this configuration"
```

### INFO01/ERROR01 Display Format

```
INFO01 (Clean/Pass items):
  Format: "Hard PHY delivery detected: PHY IPTAG found ([instance_name]: Vendor=[vendor], Product=[product], Version=[version]), Block IPTAG not found"
          "FIRM PHY delivery detected: Block IPTAG found ([instance_name]: Vendor=[vendor], Product=[product], Version=[version]), PHY IPTAG not found"
  Example: "Hard PHY delivery detected: PHY IPTAG found (cdn_hs_phy_top: Vendor=Cadence Design Systems, Inc., Product=HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R, Version=R100), Block IPTAG not found"
           "FIRM PHY delivery detected: Block IPTAG found (cdn_hs_block_top: Vendor=Cadence Design Systems, Inc., Product=HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R, Version=R100), PHY IPTAG not found"

ERROR01 (Violation/Fail items):
  Format: "ERROR: Both PHY IPTAG and Block IPTAG not found - cannot determine delivery type"
          "ERROR: Invalid configuration - both PHY IPTAG and Block IPTAG found (only one should exist)"
  Example: "ERROR: Both PHY IPTAG and Block IPTAG not found - cannot determine delivery type"
           "ERROR: Invalid configuration - both PHY IPTAG (cdn_hs_phy_top) and Block IPTAG (cdn_hs_block_top) found (only one should exist)"
```

---

## Type 1: Boolean Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-02:
  description: "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 1 performs custom boolean checks (file exists? config valid?).
PASS/FAIL based on checker's own validation logic.

**Sample Output (PASS - Hard PHY):**
```
Status: PASS
Reason: Hard PHY delivery: PHY IPTAG found, Block IPTAG not found
INFO01:
  - Hard PHY delivery detected: PHY IPTAG found (cdn_hs_phy_top: Vendor=Cadence Design Systems, Inc., Product=HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R, Version=R100), Block IPTAG not found
```

**Sample Output (PASS - FIRM PHY):**
```
Status: PASS
Reason: FIRM PHY delivery: Block IPTAG found, PHY IPTAG not found
INFO01:
  - FIRM PHY delivery detected: Block IPTAG found (cdn_hs_block_top: Vendor=Cadence Design Systems, Inc., Product=HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R, Version=R100), PHY IPTAG not found
```

**Sample Output (FAIL):**
```
Status: FAIL
Reason: Both PHY IPTAG and Block IPTAG not found - cannot determine delivery type
ERROR01:
  - ERROR: Both PHY IPTAG and Block IPTAG not found - cannot determine delivery type
```

### Type 1 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-16-0-0-02:
  description: "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: IPTAG check is informational for early development phase"
      - "Note: Missing IPTAGs are expected during integration and do not require immediate fixes"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 1 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL violations force converted: FAIL→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (violations shown as INFO for tracking)
- Used when: Check is informational only, violations expected/acceptable

**Sample Output (PASS with violations):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All violations waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: IPTAG check is informational for early development phase"
  - "Note: Missing IPTAGs are expected during integration and do not require immediate fixes"
INFO02 ([WAIVED_AS_INFO] - violations converted to PASS, shown as INFO):
  - ERROR: Both PHY IPTAG and Block IPTAG not found - cannot determine delivery type [WAIVED_AS_INFO]
```

---

## Type 2: Value Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-02:
  description: "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top"
      - "cdn_hs_block_top"
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 2 searches pattern_items in input files.
PASS/FAIL depends on check purpose:
- Violation Check: PASS if found_items empty (no violations)
- Requirement Check: PASS if missing_items empty (all requirements met)

**Sample Output (PASS - Hard PHY):**
```
Status: PASS
Reason: IPTAG pattern validated for delivery type - Hard PHY configuration satisfied
INFO01:
  - cdn_hs_phy_top (PHY IPTAG found: Vendor=Cadence Design Systems, Inc., Product=HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R, Version=R100)
  - cdn_hs_block_top (Block IPTAG not found - Hard PHY delivery confirmed)
```

### Type 2 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-16-0-0-02:
  description: "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top"
      - "cdn_hs_block_top"
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: IPTAG pattern check is informational during integration phase"
      - "Note: Pattern mismatches for delivery type are expected and approved by IP team"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 2 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL errors/mismatches force converted: ERROR→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (errors shown as INFO for tracking)
- Used when: Pattern check is informational, mismatches expected

**Sample Output (PASS with mismatches):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All mismatches waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: IPTAG pattern check is informational during integration phase"
  - "Note: Pattern mismatches for delivery type are expected and approved by IP team"
INFO02 ([WAIVED_AS_INFO] - errors converted to PASS, shown as INFO):
  - ERROR: Both PHY IPTAG and Block IPTAG not found [WAIVED_AS_INFO]
```

---

## Type 3: Value Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-02:
  description: "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top"
      - "cdn_hs_block_top"
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 2
    waive_items:
      - name: "missing_iptag_configuration"
        reason: "Waived - IPTAG configuration will be finalized in next release per IP team schedule"
```

**Check Behavior:**
Type 3 = Type 2 + waiver support.
Same pattern search logic as Type 2, plus waiver classification:
- Match found_items against waive_items
- Unwaived items → ERROR (need fix)
- Waived items → INFO with [WAIVER] tag (approved)
- Unused waivers → WARN with [WAIVER] tag
PASS if all found_items (violations) are waived.

**Sample Output (with waived items):**
```
Status: PASS
Reason: All violations waived
INFO01 (Waived):
  - missing_iptag_configuration: Both PHY and Block IPTAGs not found - Waived - IPTAG configuration will be finalized in next release per IP team schedule [WAIVER]
WARN01 (Unused Waivers):
  - unused_waiver_entry: Waiver not matched - no corresponding IPTAG violation found for this configuration
```

---

## Type 4: Boolean Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-02:
  description: "Confirm PHY has the IPTAG for Hard PHY delivery and Slices have the IPTAG for FIRM PHY delivery. (Can skip slice level IPTAG for Hard PHY delivery)"
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 2
    waive_items:
      - name: "missing_iptag_configuration"
        reason: "Waived - IPTAG configuration will be finalized in next release per IP team schedule"
```

**Check Behavior:**
Type 4 = Type 1 + waiver support.
Same boolean check as Type 1 (no pattern_items), plus waiver classification:
- Match violations against waive_items
- Unwaived violations → ERROR
- Waived violations → INFO with [WAIVER] tag
- Unused waivers → WARN with [WAIVER] tag
PASS if all violations are waived.

**Sample Output:**
```
Status: PASS
Reason: All items waived
INFO01 (Waived):
  - missing_iptag_configuration: Both PHY and Block IPTAGs not found - Waived - IPTAG configuration will be finalized in next release per IP team schedule [WAIVER]
```

---

## Testing

### Test Commands

```powershell
# Create test snapshots for all types
python common/regression_testing/create_all_snapshots.py --modules 16.0_IPTAG_CHECK --checkers IMP-16-0-0-02 --force

# Run individual tests
python IMP-16-0-0-02.py
```

---

## Notes

- **Delivery Type Detection**: The checker determines delivery type based on IPTAG presence:
  - Hard PHY: PHY IPTAG exists, Block IPTAG does not exist
  - FIRM PHY: Block IPTAG exists, PHY IPTAG does not exist
  - ERROR: Both missing or both present (invalid configuration)
- **CSV Format Dependency**: The checker relies on specific CSV column structure from IP_CHECKER tool. Version changes to the tool may require pattern updates.
- **Pattern Matching**: The checker uses flexible patterns to match *phy and *block lines, accommodating various naming conventions (e.g., cdn_hs_phy_top, cdn_hs_block_top).
- **Vendor Name Handling**: Vendor names may contain commas (e.g., "Cadence Design Systems, Inc.") requiring proper CSV quote handling in regex patterns.
- **Mutual Exclusivity**: The presence of both PHY and Block IPTAGs simultaneously is considered an error, as only one delivery type should be active.