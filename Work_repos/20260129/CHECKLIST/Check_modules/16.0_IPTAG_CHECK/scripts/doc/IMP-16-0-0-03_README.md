# IMP-16-0-0-03: Confirm use IP Type code for PHY - "P" in the slices IPTAG for FIRM PHY delivery.

## Overview

**Check ID:** IMP-16-0-0-03  
**Description:** Confirm use IP Type code for PHY - "P" in the slices IPTAG for FIRM PHY delivery.  
**Category:** IPTAG Validation  
**Input Files:** `${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv`

This checker validates that all PHY IP instances in the GDS design contain the IP Type code "P" in their IPTAG metadata. For FIRM PHY delivery (IMP-16-0-0-02), the IPTAG block must include a 2-bit IP type code set to "P" to identify PHY components. The checker parses IP_checker CSV reports containing GDS IP tag information and verifies that PHY instances (identified by product/instance names containing PHY-related keywords) have the required "P" type code marker in their instance_tag or product fields.

---

## Check Logic

### Input Parsing
The checker processes CSV reports generated by the IP_checker tool. Each CSV contains GDS IP tag information with vendor, product, version, and instance details.

**File Structure:**
1. Header line: `IP_checker filename : <tool_path>`
2. CSV column headers: `GDS, Vendor, Product, Version, Metric, Instance, Instance_tag`
3. Data rows: Comma-separated values with quoted fields containing commas

**Key Patterns:**
```python
# Pattern 1: CSV header validation
header_pattern = r'^GDS\s*,\s*Vendor\s*,\s*Product\s*,\s*Version\s*,\s*Metric\s*,\s*Instance\s*,\s*Instance_tag'
# Example: "GDS                 ,Vendor    ,Product   ,Version   ,Metric    ,Instance  ,Instance_tag"

# Pattern 2: Data row extraction (CSV format with quoted fields)
data_pattern = r'^([^,]+\.gds),"([^"]+)","?([^"]+)"?,"?([^"]+)"?,([^,]+),([^,]+),"?([^"]+)"?'
# Example: 'cdn_hs_phy_top.wIPTAG.gds,"Taiwan Semiconductor Manufacturing Corp.",tcbn05_bwph280l6p57cnod_base_lvt,"110a",0.096,AIOI21KAD1BWP280H6P57CNODLVT,"AIOI21KAD1BWP280H6P57CNODLVT"'

# Pattern 3: PHY instance identification
phy_keywords = r'cdn_hs_phy|DDR.*_T5G|_phy_|PHY'
# Example: "cdn_hs_phy_top.wIPTAG.gds" or "HPCFSC_D5D4_T5G$C202209262108$17M1X1Xb1Xe1Ya1Yb5Y2Yy2Yx2R"

# Pattern 4: IP Type code "P" validation
ip_type_p_pattern = r'\$P\$|_P_|\[P\]|IPType[=:]P'
# Example: "cdn_hs_phy_top$P$" or "DDR500_T5G$P$" or "IPType:P"
```

### Detection Logic
1. **Parse CSV files**: Skip IP_checker header line, validate CSV column headers, parse data rows using CSV reader to handle quoted fields
2. **Identify PHY instances**: Check product and instance names for PHY-related keywords (cdn_hs_phy, DDR, _phy_, PHY)
3. **Validate IP Type code**: For each PHY instance, search for "P" type code marker in instance_tag or product fields using pattern matching
4. **Classify results**:
   - **PASS (INFO01)**: PHY instances with "P" code present
   - **FAIL (ERROR01)**: PHY instances missing "P" code (violation)
5. **Aggregate statistics**: Count total instances, unique vendors/products, PHY instances found
6. **Report violations**: For missing "P" codes, output GDS file, instance name, vendor, and product for remediation

---

## Output Behavior (CRITICAL - Determines Type 2/3 Logic!)

**Check Mode:** `status_check`

Choose ONE mode based on what pattern_items represents:

### Mode 1: `existence_check` - 存在性检查
**Use when:** pattern_items are items that SHOULD EXIST in input files

```
pattern_items: ["item_A", "item_B", "item_C"]
Input file contains: item_A, item_B

Result:
  found_items:   item_A, item_B    ← Pattern found in file
  missing_items: item_C            ← Pattern NOT found in file

PASS: All pattern_items found in file
FAIL: Some pattern_items not found in file
```

### Mode 2: `status_check` - 状态检查  
**Use when:** pattern_items are items to CHECK STATUS, only output matched items

```
pattern_items: ["port_A", "port_B"]
Input file contains: port_A(fixed), port_B(unfixed), port_C(unfixed)

Result:
  found_items:   port_A            ← Pattern matched AND status correct
  missing_items: port_B            ← Pattern matched BUT status wrong
  (port_C not output - not in pattern_items)

PASS: All matched items have correct status
FAIL: Some matched items have wrong status (or pattern not matched)
```

**Selected Mode for this checker:** `status_check`

**Rationale:** This checker validates the status of PHY instances (whether they have the required "P" IP type code). When pattern_items are specified, the checker only examines those specific PHY instances and reports whether each has the correct "P" code status. Instances not in pattern_items are ignored. This is a status validation check, not an existence check.

---

## Output Descriptions (CRITICAL - Code Generator Uses These!)

This section defines the output strings used by `build_complete_output()` in the checker code.
**Fill in these values based on the check logic above.**

```python
# ⚠️ CRITICAL: Description & Reason parameter usage by Type (API-026)
# Both DESC and REASON constants are split by Type for semantic clarity:
#   Type 1/4 (Boolean): Use DESC_TYPE1_4 & REASON_TYPE1_4 (emphasize "found/not found")
#   Type 2/3 (Pattern): Use DESC_TYPE2_3 & REASON_TYPE2_3 (emphasize "matched/satisfied")

# Item description for this checker
item_desc = "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."

# PASS case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_desc_type1_4 = "All PHY instances found with IP Type code 'P' in IPTAG"
# Type 2/3: Pattern checks - emphasize "matched/satisfied" (pattern validation)
found_desc_type2_3 = "All PHY instances validated with IP Type code 'P' in IPTAG"

# PASS reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "found/not found" (existence)
found_reason_type1_4 = "All PHY instances found with required IP Type code 'P' in IPTAG for FIRM PHY delivery"
# Type 2/3: Pattern checks - emphasize pattern matching terms (matched|satisfied|validated|compliant|fulfilled)
found_reason_type2_3 = "All PHY instances matched and validated with IP Type code 'P' in IPTAG for FIRM PHY delivery"

# FAIL case descriptions - Split by Type semantics (API-026)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_desc_type1_4 = "PHY instances not found with IP Type code 'P' in IPTAG"
# Type 2/3: Pattern checks - emphasize pattern mismatch
missing_desc_type2_3 = "PHY instances missing required IP Type code 'P' in IPTAG"

# FAIL reasons - Split by Type semantics (ALL Types need these)
# Type 1/4: Boolean checks - emphasize "not found" (absence)
missing_reason_type1_4 = "PHY instances not found with required IP Type code 'P' in IPTAG - FIRM PHY delivery requires 'P' type code"
# Type 2/3: Pattern checks - emphasize pattern mismatch terms (not satisfied|missing|failed)
missing_reason_type2_3 = "PHY instances missing required IP Type code 'P' in IPTAG - FIRM PHY delivery validation not satisfied"

# WAIVED case descriptions (ALL Types need these)
# Type 1/2 use in waiver=0 mode for waive_items comments
# Type 3/4 use for actual waived violations
waived_desc = "PHY instances with waived IP Type code 'P' requirement"

# WAIVED reasons (Type 3/4 ONLY - actual waiver logic)
waived_base_reason = "PHY instance IP Type code 'P' requirement waived per design team approval"

# UNUSED waivers (Type 3/4 ONLY)
unused_desc = "Unused waiver entries for PHY IP Type code validation"
unused_waiver_reason = "Waiver not matched - no corresponding PHY instance violation found in GDS IPTAG report"
```

### INFO01/ERROR01 Display Format

```
INFO01 (Clean/Pass items):
  Format: "[instance_name] GDS: {gds_file} | Vendor: {vendor} | Product: {product} | IP Type 'P' VALIDATED"
  Example: "cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G$P$C202209262108 | IP Type 'P' VALIDATED"

ERROR01 (Violation/Fail items):
  Format: "[instance_name] GDS: {gds_file} | Vendor: {vendor} | Product: {product} | MISSING PHY IP Type 'P' in IPTAG"
  Example: "cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG"
```

---

## Type 1: Boolean Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-03:
  description: "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 1 performs custom boolean checks (file exists? config valid?).
PASS/FAIL based on checker's own validation logic.

**Sample Output (PASS):**
```
Status: PASS
Reason: All PHY instances found with required IP Type code 'P' in IPTAG for FIRM PHY delivery
INFO01:
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G$P$C202209262108 | IP Type 'P' VALIDATED
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G$P$ | IP Type 'P' VALIDATED
```

**Sample Output (FAIL):**
```
Status: FAIL
Reason: PHY instances not found with required IP Type code 'P' in IPTAG - FIRM PHY delivery requires 'P' type code
ERROR01:
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG
```

### Type 1 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-16-0-0-03:
  description: "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: This check is informational only for early design phases where IPTAG 'P' code is not yet finalized"
      - "Note: Missing 'P' codes are expected during initial PHY integration and do not block delivery"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 1 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL violations force converted: FAIL→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (violations shown as INFO for tracking)
- Used when: Check is informational only, violations expected/acceptable

**Sample Output (PASS with violations):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All violations waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: This check is informational only for early design phases where IPTAG 'P' code is not yet finalized"
  - "Note: Missing 'P' codes are expected during initial PHY integration and do not block delivery"
INFO02 ([WAIVED_AS_INFO] - violations converted to PASS, shown as INFO):
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVED_AS_INFO]
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVED_AS_INFO]
```

---

## Type 2: Value Check

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-03:
  description: "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top"
      - "DDR_PHY_SLICE"
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: N/A
    waive_items: []
```

**Check Behavior:**
Type 2 searches pattern_items in input files.
PASS/FAIL depends on check purpose:
- Violation Check: PASS if found_items empty (no violations)
- Requirement Check: PASS if missing_items empty (all requirements met)

**Sample Output (PASS):**
```
Status: PASS
Reason: All PHY instances matched and validated with IP Type code 'P' in IPTAG for FIRM PHY delivery
INFO01:
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G$P$C202209262108 | IP Type 'P' VALIDATED
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G$P$ | IP Type 'P' VALIDATED
```

### Type 2 Variant: waivers.value=0 (Forced PASS Mode)

**Configuration:**
```yaml
IMP-16-0-0-03:
  description: "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."
  requirements:
    value: 0
    pattern_items:
      - "cdn_hs_phy_top"
      - "DDR_PHY_SLICE"
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 0  # CRITICAL: value=0 triggers forced PASS mode (NOT waiver logic!)
    waive_items:  # IMPORTANT: Use PLAIN STRING format (NOT name/reason dict!)
      - "Explanation: This check is informational only for pre-release validation where IPTAG 'P' code is optional"
      - "Note: Pattern mismatches are expected during PHY development phase and do not require immediate fixes"
```

**CRITICAL Behavior (waivers.value=0):**
- NOTE: Type 2 has NO waiver logic. waive=0 is forced PASS mode only
- IMPORTANT: waive_items uses PLAIN STRINGS (NOT name/reason dict like Type 3/4!)
- waive_items serves as COMMENT ONLY (no matching/filtering logic)
- waive_items content printed as INFO with [WAIVED_INFO] tag
- ALL errors/mismatches force converted: ERROR→PASS, displayed as INFO with [WAIVED_AS_INFO] tag
- Check ALWAYS returns PASS (errors shown as INFO for tracking)
- Used when: Pattern check is informational, mismatches expected

**Sample Output (PASS with mismatches):**
```
Status: PASS  # Always PASS when waivers.value=0
Reason: All mismatches waived as informational
INFO01 ([WAIVED_INFO] - waive_items as comment):
  - "Explanation: This check is informational only for pre-release validation where IPTAG 'P' code is optional"
  - "Note: Pattern mismatches are expected during PHY development phase and do not require immediate fixes"
INFO02 ([WAIVED_AS_INFO] - errors converted to PASS, shown as INFO):
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVED_AS_INFO]
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVED_AS_INFO]
```

---

## Type 3: Value Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-03:
  description: "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."
  requirements:
    value: 2
    pattern_items:
      - "cdn_hs_phy_top"
      - "DDR_PHY_SLICE"
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 2
    waive_items:
      - name: "cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG"
        reason: "Waived - legacy PHY instance uses alternative IPTAG format per design team approval"
      - name: "DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG"
        reason: "Waived - third-party PHY IP does not support 'P' type code, verified by vendor documentation"
```

**Check Behavior:**
Type 3 = Type 2 + waiver support.
Same pattern search logic as Type 2, plus waiver classification:
- Match found_items against waive_items
- Unwaived items → ERROR (need fix)
- Waived items → INFO with [WAIVER] tag (approved)
- Unused waivers → WARN with [WAIVER] tag
PASS if all found_items (violations) are waived.

**Sample Output (with waived items):**
```
Status: PASS
Reason: All violations waived
INFO01 (Waived):
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVER]
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVER]
WARN01 (Unused Waivers):
  - (none)
```

---

## Type 4: Boolean Check with Waiver Logic

**Configuration (copy to item_data.yaml for testing):**
```yaml
IMP-16-0-0-03:
  description: "Confirm use IP Type code for PHY - \"P\" in the slices IPTAG for FIRM PHY delivery."
  requirements:
    value: N/A
    pattern_items: []
  input_files:
    - ${CHECKLIST_ROOT}/IP_project_folder/reports/16.0/cdn_hs_phy_top.csv
  waivers:
    value: 2
    waive_items:
      - name: "cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG"
        reason: "Waived - legacy PHY instance uses alternative IPTAG format per design team approval"
      - name: "DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG"
        reason: "Waived - third-party PHY IP does not support 'P' type code, verified by vendor documentation"
```

**Check Behavior:**
Type 4 = Type 1 + waiver support.
Same boolean check as Type 1 (no pattern_items), plus waiver classification:
- Match violations against waive_items
- Unwaived violations → ERROR
- Waived violations → INFO with [WAIVER] tag
- Unused waivers → WARN with [WAIVER] tag
PASS if all violations are waived.

**Sample Output:**
```
Status: PASS
Reason: All items waived
INFO01 (Waived):
  - cdn_hs_phy_top GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: HPCFSC_D5D4_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVER]
  - DDR_PHY_SLICE GDS: cdn_hs_phy_top.wIPTAG.gds | Vendor: Cadence Design Systems, Inc. | Product: DDR500_T5G | MISSING PHY IP Type 'P' in IPTAG [WAIVER]
```

---

## Testing

### Test Commands

```powershell
# Create test snapshots for all types
python common/regression_testing/create_all_snapshots.py --modules 16.0_IPTAG_CHECK --checkers IMP-16-0-0-03 --force

# Run individual tests
python IMP-16-0-0-03.py
```

---

## Notes

**Limitations:**
- Checker relies on IP_checker CSV report format - changes to tool output may require pattern updates
- PHY instance identification uses keyword matching (cdn_hs_phy, DDR, _phy_, PHY) - may need adjustment for new PHY naming conventions
- IP Type code "P" detection supports multiple formats ($P$, _P_, [P], IPType:P) - verify format matches your IPTAG standard

**Known Issues:**
- CSV files with missing headers are parsed with assumed column order - may cause incorrect field extraction
- Quoted fields containing commas require proper CSV parser (csv.reader) - regex-only parsing will fail
- Mixed case in IP type codes normalized to uppercase - ensure case-insensitive matching

**Edge Cases:**
- Empty CSV files report INFO01 with zero counts (PASS)
- Non-PHY instances ignored for 'P' code validation but counted in statistics
- Multiple GDS files in single CSV tracked separately in per-file statistics
- Instances with multiple IPTAG markers (e.g., both $P$ and IPType:P) counted as single PASS