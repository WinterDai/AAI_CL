# IMP-5-0-0-03: 库 Corner 检查器

## 概述

**检查项描述：** 确认目标标准单元库 corner 正确

**检查类型：** 统一自动检测型（支持 Type 1/2/3/4 四种模式）

**输入文件：** `qor.rpt`（综合质量报告）

---

## 检查逻辑

### 输入文件解析
- 解析 `qor.rpt` 中的 "Library domain:" 行
- 提取库 corner 信息（通常包含在 domain 字符串中）
- 格式示例：
  ```
  Library domain: tcond_ssgnp_0p675v_m40c_cworst_CCworst_T
  ```

### Corner 提取模式
使用正则表达式 `tcond_(.*?_T)` 提取 corner：
- 完整 domain: `tcond_ssgnp_0p675v_m40c_cworst_CCworst_T`
- 提取的 corner: `ssgnp_0p675v_m40c_cworst_CCworst_T`

### Corner 组成部分
典型 corner 包含：
- **Process corner**: `ssgnp` (Slow-Slow/Typical/Fast-Fast)
- **Voltage**: `0p675v` (0.675V)
- **Temperature**: `m40c` (-40°C)
- **RC corner**: `cworst_CCworst`
- **Suffix**: `_T` (timing)

### 违例定义
- **Corner 不匹配期望值** = 违例（Type 2/3）
- **Corner 缺失** = 违例（所有 Type）
- Type 1 模式：仅报告，不判定违例

---

## 自动类型检测

检查器根据配置自动检测运行类型：

| Type | requirements.value | pattern_items | waivers.value | 描述 |
|------|-------------------|---------------|--------------|------|
| Type 1 | N/A | - | N/A 或 0 | 布尔检查（无豁免逻辑） |
| Type 2 | >0 | 有 | N/A 或 0 | 数值比较（无豁免逻辑） |
| Type 3 | >0 | 有 | >0 | 数值比较 + 豁免逻辑 |
| Type 4 | N/A | - | >0 | 布尔检查 + 豁免逻辑 |

---

## Type 1: 布尔检查（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-03:
  check_item: "Confirm target standard cell library corners are correct?"
  requirements:
    value: N/A
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\reports\qor.rpt
```

### 检查行为

- **PASS 场景：** 总是 PASS，无论 corner 是什么
- **输出内容：** 报告检测到的 corner
- **用途：** 信息记录和确认库 corner 配置

### 输出示例

**情况 1：检测到 corner（PASS）**
```
Check Result: PASS
Value: 1

INFO01: Library corner detected in synthesis:
  - ssgnp_0p675v_m40c_cworst_CCworst_T
```

详细报告：
```
PASS:IMP-5-0-0-03:Confirm target standard cell library corners are correct?
Info Occurrence: 1
1: Info: ssgnp_0p675v_m40c_cworst_CCworst_T. In line 5, qor.rpt: Library corner is being used
```

**情况 2：未检测到 corner（PASS with INFO）**
```
Check Result: PASS
Value: 0

INFO01: Library corner not detected in QoR:
  - No library corner detected
```

**情况 3：waiver=0 显示模式**
```yaml
waivers:
  value: 0
  waive_items:
    - "ssgnp_0p675v_m40c_cworst_CCworst_T"
```

输出：
```
Check Result: PASS (WAIVED)
Value: 1

INFO01:
  - ssgnp_0p675v_m40c_cworst_CCworst_T[WAIVED_AS_INFO]
```

---

## Type 2: 数值比较（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-03:
  check_item: "Confirm target standard cell library corners are correct?"
  requirements:
    value: 1
    pattern_items:
      - "ssgnp_0p675v_m40c_cworst_CCworst_T"  # 期望的 corner
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\reports\qor.rpt
```

### 检查行为

- **比较：** 实际 corner vs pattern_items[0]（期望 corner）
- **PASS 条件：** corner 完全匹配或包含期望值
- **匹配规则：**
  - 精确匹配：`ssgnp_0p675v_m40c_cworst_CCworst_T`
  - 大小写不敏感匹配
  - 子串匹配：期望值是实际值的子串

### 输出示例

**情况 1：Corner 匹配（PASS）**
```
Check Result: PASS
Value: 1

INFO01: Library corner matches expected:
  - ssgnp_0p675v_m40c_cworst_CCworst_T: Library corner matches expected
```

**情况 2：Corner 不匹配（FAIL）**
```yaml
# 期望
pattern_items:
  - "ssgnp_0p675v_m40c_cworst_CCworst_T"

# 实际
Library domain: tcond_ffgnp_0p775v_125c_cbest_CCbest_T
```

输出：
```
Check Result: FAIL
Value: 1

ERROR01: Library corner doesn't match expected value:
  - ffgnp_0p775v_125c_cbest_CCbest_T: Target standard cell library corners aren't correct and expected ssgnp_0p675v_m40c_cworst_CCworst_T
```

**情况 3：Corner 缺失但期望存在（FAIL）**
```
Check Result: FAIL
Value: 0

ERROR01: Library corner information missing:
  - Missing corner information: Information related to library corner is missing in logs and reports, expected ssgnp_0p675v_m40c_cworst_CCworst_T
```

**情况 4：waiver=0 强制通过**
```yaml
waivers:
  value: 0
  waive_items: ["Temporary exception"]
```

输出：
```
Check Result: PASS (WAIVED)
Value: 1

INFO01:
  - ffgnp_0p775v_125c_cbest_CCbest_T: Corner check waived (expected: ssgnp_0p675v_m40c_cworst_CCworst_T)[WAIVED_AS_INFO]
  - Temporary exception[WAIVED_AS_INFO]
```

---

## Type 3: 数值比较 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-03:
  check_item: "Confirm target standard cell library corners are correct?"
  requirements:
    value: 1
    pattern_items:
      - "cworst_CCworst_T"  # 期望 worst corner
  waivers:
    value: 1
    waive_items:
      - name: "cbest_CCbest_T"
        reason: "Using best corner for power analysis per JIRA-1234"
  input_files:
    - C:\path\to\reports\qor.rpt
```

### 检查行为

- **Corner 匹配检查：** 验证 corner 是否符合期望
- **豁免逻辑：** 不符合期望的 corner 可以豁免
- **PASS 条件：** corner 匹配期望 OR corner 在豁免列表中

### 输出示例

**情况 1：Corner 匹配期望（PASS）**
```
Check Result: PASS
Value: 1

INFO01: Library corner status:
  - ssgnp_0p675v_m40c_cworst_CCworst_T: Library corner matches expected
```

**情况 2：Corner 不匹配但已豁免（PASS）**
```
# 实际
Library domain: tcond_ffgnp_0p775v_125c_cbest_CCbest_T

Check Result: PASS
Value: 1

INFO01: Library corner status:
  - cbest_CCbest_T: Using best corner for power analysis per JIRA-1234[WAIVER]
```

**情况 3：Corner 不匹配且未豁免（FAIL）**
```
# 实际
Library domain: tcond_typical_0p72v_25c_T

Check Result: FAIL
Value: 1

ERROR01: Unwaived library corner mismatch:
  - typical_0p72v_25c_T: Target standard cell library corners aren't correct and expected cworst_CCworst_T
```

**情况 4：豁免未使用（PASS with WARN）**
```
Check Result: PASS
Value: 1

INFO01: Library corner status:
  - cworst_CCworst_T: Library corner matches expected

WARN01: Unused waivers:
  - cbest_CCbest_T: Waived item not found in check[WAIVER]
```

---

## Type 4: 布尔检查 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-03:
  check_item: "Confirm target standard cell library corners are correct?"
  requirements:
    value: N/A
  waivers:
    value: 1
    waive_items:
      - name: "cbest_CCbest_T"
        reason: "Power optimization corner approved"
  input_files:
    - C:\path\to\reports\qor.rpt
```

### 检查行为

- **布尔检查：** 检查 corner 是否存在
- **豁免逻辑：** 特定 corner 可以豁免（通常用于非标准 corner）
- **PASS 条件：** Corner 存在且已确认

### 输出示例

**情况 1：Corner 检测到（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: Library corner detected:
  - ssgnp_0p675v_m40c_cworst_CCworst_T: Library corner is being used
```

**情况 2：非标准 corner 但已豁免（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: Library corner detected:
  - cbest_CCbest_T: Power optimization corner approved[WAIVER]
```

**情况 3：Corner 缺失（FAIL）**
```
Check Result: FAIL
Value: N/A

ERROR01: Library corner not found:
  - No corner information: Library corner information missing in qor.rpt
```

---

## 配置错误处理

### 缺失输入文件

```yaml
input_files:
  - C:\path\to\missing_qor.rpt
```

**输出：**
```
Check Result: FAIL
Value: 0

ERROR01: Configuration error - input files missing or unreadable
  - C:\path\to\missing_qor.rpt: File does not exist
```

### qor.rpt 无 Library domain

如果 qor.rpt 中没有 "Library domain:" 行：

```
Check Result: FAIL (Type 2/3/4 with expected value)
或
Check Result: PASS (Type 1 or Type 2/3/4 without expected value)

WARN01: Golden value expected but not provided
INFO01: 
  - Corner information not found in qor.rpt
```

---

## Corner 匹配规则

### 精确匹配
```
期望: ssgnp_0p675v_m40c_cworst_CCworst_T
实际: ssgnp_0p675v_m40c_cworst_CCworst_T
结果: ✅ 匹配
```

### 大小写不敏感
```
期望: cworst_CCworst_T
实际: CWORST_CCWORST_T
结果: ✅ 匹配
```

### 子串匹配
```
期望: cworst_CCworst
实际: ssgnp_0p675v_m40c_cworst_CCworst_T
结果: ✅ 匹配（期望值是实际值的子串）
```

### 不匹配示例
```
期望: cworst_CCworst_T
实际: cbest_CCbest_T
结果: ❌ 不匹配
```

---

## 常见 Corner 类型

| Corner Type | Process | Voltage | Temp | RC | 用途 |
|-------------|---------|---------|------|-----|------|
| **cworst_CCworst** | SS | Low | High | Worst | Setup timing |
| **cbest_CCbest** | FF | High | Low | Best | Hold timing |
| **typical** | TT | Nominal | 25°C | Typ | Functional |
| **rcworst** | - | - | - | Worst RC | Max cap |
| **rcbest** | - | - | - | Best RC | Min cap |

---

## 输出文件说明

### Log 文件（分组格式）
- **INFO01:** 检测到的 corner 和已豁免 corner
- **ERROR01:** Corner 不匹配或缺失
- **WARN01:** 未使用的豁免项

### Report 文件（详细列表）
每个 corner 包含：
- Corner 名称
- 行号（在 qor.rpt 中的位置）
- 文件路径
- 状态说明（匹配/不匹配/豁免）

---

## 使用建议

### 1. 初次使用（Type 1）
简单报告使用的 corner：
```yaml
requirements:
  value: N/A
waivers:
  value: N/A
```

### 2. 严格验证 Corner（Type 2）
确保使用正确的 corner：
```yaml
requirements:
  value: 1
  pattern_items:
    - "ssgnp_0p675v_m40c_cworst_CCworst_T"
waivers:
  value: N/A
```

### 3. 允许多个 Corner（Type 3）
某些场景允许使用替代 corner：
```yaml
requirements:
  value: 1
  pattern_items:
    - "cworst_CCworst_T"  # 主 corner
waivers:
  value: 2
  waive_items:
    - name: "cbest_CCbest_T"
      reason: "For hold timing analysis"
    - name: "typical"
      reason: "For functional verification"
```

---

## 常见问题

**Q1: 为什么检测不到 corner？**
- 检查 qor.rpt 中是否有 "Library domain:" 行
- 确认 domain 字符串包含 `tcond_` 前缀
- 验证 corner 格式符合 `tcond_XXX_T` 模式

**Q2: Corner 名称过长怎么配置？**
- 可以只配置 corner 的关键部分（如 `cworst_CCworst_T`）
- 使用子串匹配，无需完整名称

**Q3: 支持多个 corner 吗？**
- 当前实现提取第一个找到的 corner
- 如需支持多个，需要修改解析逻辑

**Q4: 什么时候应该使用 Type 3？**
- 项目需要在不同阶段使用不同 corner
- 需要跟踪和审批 corner 变更
- 有正当理由使用非标准 corner

---

## Corner 命名规范

### 标准格式
```
[process]_[voltage]_[temperature]_[rc_corner]_T
```

### 示例解析
```
ssgnp_0p675v_m40c_cworst_CCworst_T
│     │       │     │       │       └─ Timing library suffix
│     │       │     │       └───────── RC corner (C-worst)
│     │       │     └───────────────── RC corner (RC-worst)  
│     │       └─────────────────────── Temperature (-40°C)
│     └─────────────────────────────── Voltage (0.675V)
└───────────────────────────────────── Process (SS-GNP)
```

---

## 与其他 Checker 的关联

### IMP-5-0-0-00: Library Models
- **00** 检查加载的库文件列表
- **03** 检查库的 corner 类型

### IMP-5-0-0-02: QRC Tech File
- **02** 检查 rc_corner 配置
- **03** 检查 library corner（应该一致）

---

## 维护建议

1. **Corner 标准化：** 定义项目允许的 corner 列表
2. **豁免审批：** 非标准 corner 需要设计负责人审批
3. **阶段管理：** 不同设计阶段可能使用不同 corner
4. **文档化：** 记录每个 corner 的用途和使用场景

---

**文档版本：** 1.0  
**更新日期：** 2025-11-26  
**作者：** yuyin
