# IMP-5-0-0-15: DFT Checks Pass Verification

## 概述

**检查目标**: 确认所有 DFT（Design For Test）检查通过

**支持的 Checker 类型**: Type 1 / Type 2 / Type 3 / Type 4 (自动检测)

**输入文件**: 综合日志文件（包含 DFT 规则检查结果）

---

## 检查逻辑

### 核心功能

1. **解析 DFT 检查结果**
   - 从综合日志中查找 "Checking DFT rules for" 部分
   - 提取 DFT 规则违例（Error : DFT ... Rule Violation）
   - 记录每个违例的类型、描述、vid 标识符和行号

2. **DFT 违例类型**
   - `DFT Async Rule Violation`: 异步 set/reset 信号违例
   - `DFT Clock Rule Violation`: 时钟信号违例
   - 其他 DFT 相关规则违例

3. **自动类型检测**
   - 根据 YAML 配置自动判断使用 Type 1/2/3/4
   - 支持违例类型模式匹配和豁免逻辑

4. **分类输出**
   - 按 DFT 违例类型组织 ERROR/INFO/WARN 输出
   - 每种违例类型单独分组显示

---

## 四种检查类型

### Type 1: 布尔检查（无豁免逻辑）

**配置示例**:
```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: N/A
  waive_items: []
```

**检查逻辑**:
- 检查是否存在任何 DFT 违例
- **PASS**: 所有 DFT 检查通过（无违例）
- **FAIL**: 存在任何 DFT 违例

**输出示例 (PASS)**:
```
PASS:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: 0

INFO01: All DFT checks pass
  Severity: Info Occurrence: 0
```

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: 10

ERROR01: DFT Async Rule Violation
  Severity: Fail Occurrence: 10
  - async signal driven to a constant active value, possibly due to a polarity conflict...
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_5'...
  ...
```

**特殊模式 (waiver=0)**:
```yaml
waivers:
  value: 0  # 强制 PASS，所有 FAIL 转为 INFO
```

---

### Type 2: 数值比较（无豁免逻辑）

**配置示例**:
```yaml
requirements:
  value: 0  # 期望违例数
  pattern_items:
    - "DFT Async Rule Violation"     # 精确匹配违例类型
    - "*Clock*"                      # 通配符匹配
    - "^DFT.*Violation$"             # 正则表达式
waivers:
  value: N/A
  waive_items: []
```

**检查逻辑**:
1. 使用 `pattern_items` 匹配特定类型的 DFT 违例
2. 统计匹配的违例数量
3. 比较：实际违例数 vs `requirements.value`
4. **PASS**: 违例数 == 期望值
5. **FAIL**: 违例数 != 期望值

**模式匹配规则**:
- `DFT Async Rule Violation` → 精确匹配违例类型
- `*Async*` → 匹配包含 "Async" 的任何违例
- `^DFT.*Violation$` → 正则表达式

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: 10 (Expected: 0)

Fail Occurrence: 10
1: Fail: async signal driven to a constant active value... In line 33, dft_check.log: DFT Async Rule Violation
2: Fail: async signal driven to a constant active value... In line 39, dft_check.log: DFT Async Rule Violation
...
```

---

### Type 3: 数值比较 + 豁免逻辑

**配置示例**:
```yaml
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"
waivers:
  value: 5
  waive_items:
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3'"
      reason: "Known design constraint - approved by DFT team - Ticket#12345"
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_5'"
      reason: "Hardware limitation - documented in spec section 4.2"
```

**检查逻辑**:
1. 使用 `pattern_items` 匹配特定类型的违例
2. 分离违例:
   - **未豁免违例** → ERROR（需要修复）
   - **已豁免违例** → INFO（批准的例外）
   - **未使用的豁免** → WARN（配置了但未用到）
   - **未匹配的模式** → INFO（未发现违例，好事）
3. **PASS**: len(未豁免违例) == 0
4. **FAIL**: len(未豁免违例) > 0

**输出示例 (PASS - 全部豁免)**:
```
PASS:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: 2 (all waived)

INFO01: Waived: DFT Async Rule Violation
  Severity: Info Occurrence: 2
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_3'
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_5'
```

**输出示例 (FAIL - 部分未豁免)**:
```
FAIL:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: 10 (8 unwaived)

ERROR01: DFT Async Rule Violation
  Severity: Fail Occurrence: 8
  - async signal driven to a constant active value, module 'module_new_1'...
  - async signal driven to a constant active value, module 'module_new_2'...
  ...

INFO01: Waived: DFT Async Rule Violation
  Severity: Info Occurrence: 2
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_3'
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_5'
```

---

### Type 4: 布尔检查 + 豁免逻辑

**配置示例**:
```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: 20
  waive_items:
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_3'"
      reason: "Power domain crossing - approved design pattern"
    - name: "DFT Clock Rule Violation:internally driven clock net in module 'clk_gen'"
      reason: "Clock gating implementation - functional requirement"
```

**检查逻辑**:
1. 检查所有 DFT 违例（不使用模式匹配）
2. 分离:
   - **未豁免的** → ERROR（需要修复或豁免）
   - **已豁免的** → INFO（批准的例外）
   - **未使用的豁免** → WARN（配置错误）
3. **PASS**: 所有违例都有豁免
4. **FAIL**: 存在未豁免的违例

**输出示例 (PASS)**:
```
PASS:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: N/A

INFO01: Waived: DFT Async Rule Violation
  Severity: Info Occurrence: 10
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_3'
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_5'
  ...

INFO02: Waived: DFT Clock Rule Violation
  Severity: Info Occurrence: 3
  - internally driven clock net in module 'clk_gen'
  ...
```

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-15:Confirm all DFT checks pass?
Value: N/A

ERROR01: DFT Async Rule Violation
  Severity: Fail Occurrence: 5
  - async signal driven to a constant active value, new module...
  ...

INFO01: Waived: DFT Async Rule Violation
  Severity: Info Occurrence: 5
  - async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_3'
  ...
```

---

## 输入文件格式

### 综合日志文件结构

```
... synthesis steps ...

  Checking DFT rules for 'module_name' module under 'LV' style

Detected 10 DFT rule violation(s)
	Summary of check_dft_rules
	**************************
	Number of usable scan cells: 752
Clock Rule Violations:
---------------------
	  Internally driven clock net: 0
	      Tied constant clock net: 0
	           Undriven clock net: 0
	Conflicting async & clock net: 0
	              Misc. clock net: 0

Async. set/reset Rule Violations:
--------------------------------
	Internally driven async net: 0
	      Tied active async net: 10
	         Undriven async net: 0
	            Misc. async net: 0

   Total number of DFT violations: 10

Info   : Message severity has been changed from default value. [MESG-7]
       : Message 'DFT-302' default severity is 'Warning'
Error  : DFT Async Rule Violation. [DFT-302] [check_dft_rules]
       : # 0 <vid 0_async>: async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3', net 'genblk1_genblk1_reset_n_inv', inst/pin 'U_cm_cpl_ctrl_if/cb'  [ASYNC-02]
       : #sync signal is not controllable. Affected registers will be excluded from scan design.

Info   : Message severity has been changed from default value. [MESG-7]
       : Message 'DFT-302' default severity is 'Warning'
Error  : DFT Async Rule Violation. [DFT-302] [check_dft_rules]
       : # 1 <vid 1_async>: async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_5', net 'genblk1_genblk1_reset_n_inv', inst/pin 'U_cm_cpl_ctrl_if/cb'  [ASYNC-02]

... continue synthesis ...
```

**解析逻辑**:
1. 识别 DFT 检查区域（"Checking DFT rules for" 开始）
2. 提取错误类型（`Error : DFT ... Rule Violation`）
3. 提取违例详情（带 vid 标识符的行）
4. 记录行号和文件路径用于报告

---

## 输出格式

### 违例命名格式

```
error_type:violation_description
```

示例:
- `DFT Async Rule Violation:async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3'`
- `DFT Clock Rule Violation:internally driven clock net in module 'clk_gen'`

### 分组策略

**Type 1/2**: 按违例类型分组
```
ERROR01: DFT Async Rule Violation
ERROR02: DFT Clock Rule Violation
```

**Type 3/4**: 按违例类型和严重性分组
```
ERROR01: DFT Async Rule Violation (unwaived)
INFO01: Waived: DFT Async Rule Violation
INFO02: Waived: DFT Clock Rule Violation
WARN01: Unused waivers
```

---

## 配置切换示例

### 场景 1: 初始 DFT 检查（严格模式）

**需求**: 不允许任何 DFT 违例

```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: N/A
  waive_items: []
```

**结果**: Type 1 - 发现任何违例都会 FAIL

---

### 场景 2: 关注特定违例类型

**需求**: 只检查异步信号违例

```yaml
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"
waivers:
  value: N/A
  waive_items: []
```

**结果**: Type 2 - 只统计 Async 违例，其他类型忽略

---

### 场景 3: 批准已知违例（推荐）

**需求**: 允许经过审批的特定 DFT 违例

```yaml
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"
waivers:
  value: 10
  waive_items:
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_3'"
      reason: "Power domain crossing - DFT team approved - Ticket#67890"
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, module 'cdnsdrq_data_sync_synth_lh0_4_5'"
      reason: "Clock domain crossing - required by architecture"
```

**结果**: Type 3 - 未豁免的违例 = FAIL，已豁免 = INFO

---

### 场景 4: 全面违例管理

**需求**: 所有 DFT 违例都需要豁免或修复

```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: 50
  waive_items:
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, module 'module_1'"
      reason: "Power domain requirement - spec section 3.2"
    - name: "DFT Clock Rule Violation:internally driven clock in module 'clk_ctrl'"
      reason: "Clock gating optimization - timing closure approved"
    # ... 更多豁免项
```

**结果**: Type 4 - 所有违例要么修复，要么有豁免

---

## 最佳实践

### 1. 豁免命名规范

```yaml
waive_items:
  - name: "violation_type:full_violation_description"
    reason: "Brief reason - Ticket#XXXXX or Email reference"
```

**示例**:
```yaml
waive_items:
  - name: "DFT Async Rule Violation:async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3', net 'genblk1_genblk1_reset_n_inv'"
    reason: "Power domain crossing - approved by DFT team - cannot be avoided due to architecture constraints - Ticket#12345"
```

### 2. 豁免理由要求

- ✅ **好的理由**: "Power domain crossing - DFT team approved - required by low-power architecture - cannot scan across power domains - Ticket#12345"
- ✅ **好的理由**: "Clock gating cell - functional requirement - timing analysis complete - Email 2025-11-20"
- ❌ **差的理由**: "Waived"
- ❌ **差的理由**: "Cannot fix"

### 3. 违例名称匹配技巧

**完整匹配**（推荐）:
```yaml
name: "DFT Async Rule Violation:async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3', net 'genblk1_genblk1_reset_n_inv', inst/pin 'U_cm_cpl_ctrl_if/cb'"
```

**部分匹配**（如果描述太长）:
- 确保包含关键信息：违例类型 + 模块名
- 但要注意可能匹配多个违例

### 4. 定期审查

- 每次综合后重新运行检查
- 检查 WARN（未使用的豁免）→ 删除过时的豁免项
- 新增违例 → 需要分析根因并添加豁免或修复设计

### 5. 渐进式严格化

**阶段 1** (初期开发):
```yaml
# Type 4: 允许所有违例类型，但需要豁免
requirements:
  value: N/A
waivers:
  value: 100
```

**阶段 2** (DFT 优化):
```yaml
# Type 3: 限制特定违例
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"  # 重点优化异步违例
waivers:
  value: 20
```

**阶段 3** (接近 Tape-out):
```yaml
# Type 2: 严格检查
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"
    - "DFT Clock Rule Violation"
waivers:
  value: N/A  # 不允许新豁免
```

---

## 故障排查

### 问题 1: "Missing input files"

**原因**: 输入文件路径错误或文件不存在

**解决**:
```yaml
input_files: C:\path\to\synthesis\genus.syn_generic.log
```

检查:
1. 路径是否正确（绝对路径）
2. 文件是否存在
3. 文件是否可读
4. 确认文件包含 "Checking DFT rules for" 部分

---

### 问题 2: 豁免未生效

**症状**: 已豁免的违例仍然显示为 FAIL

**原因**: 豁免项名称与日志中的描述不完全匹配

**检查**:
1. 违例名称必须包含类型前缀
   - ✅ `"DFT Async Rule Violation:async signal..."`
   - ❌ `"async signal..."` (缺少类型)

2. 描述必须完全匹配日志中的文本
   - ✅ `"async signal driven to a constant active value, possibly due to a polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3'"`
   - ❌ `"async signal in module cdnsdrq_data_sync_synth_lh0_4_3"` (描述不同)

3. 检查日志中的实际描述
   ```bash
   # 查看日志中的违例描述
   grep "Error.*DFT.*Rule Violation" synthesis.log -A 1
   ```

---

### 问题 3: 未找到 DFT 违例

**症状**: 检查器报告 0 个违例，但日志中明确有违例

**可能原因**:
1. **日志格式不匹配**: 检查器期望特定的日志格式
   - 必须包含 "Checking DFT rules for"
   - 错误行格式：`Error  : DFT ... Rule Violation`
   - vid 格式：`# N <vid N_type>: description`

2. **编码问题**: 日志文件编码不是 UTF-8
   ```python
   # 检查文件编码
   with open('log_file', 'rb') as f:
       print(f.read(100))
   ```

3. **日志文件截断**: 确认 DFT 检查部分在日志中完整

---

### 问题 4: WARN - 未使用的豁免

**症状**: `WARN01: Unused waivers`

**原因**: 豁免项在日志中找不到

**可能性**:
1. 设计已修复，违例不存在 → **删除豁免项**（好事！）
2. 违例描述拼写错误 → **修正描述**
3. 违例类型错误 → **检查是 Async 还是 Clock**
4. 日志未更新 → **重新运行综合并生成新日志**

**调试方法**:
```bash
# 在日志中搜索豁免项的关键词
grep "module_name" synthesis.log
```

---

### 问题 5: 违例数量不符合预期

**症状**: Type 2 检查显示的违例数与预期不同

**调试**:
1. 检查 `pattern_items` 是否正确匹配
   ```yaml
   pattern_items:
     - "DFT Async Rule Violation"  # 精确匹配
     - "*Async*"                   # 通配符可能匹配更多
   ```

2. 手动统计日志中的违例
   ```bash
   grep "Error.*DFT Async Rule Violation" synthesis.log | wc -l
   ```

3. 检查是否有其他类型的 DFT 违例被忽略

---

## 技术细节

### 核心类和方法

```python
class DFTCheckChecker(BaseChecker):
    # 主执行流程
    def execute_check(self) -> CheckResult
    
    # 输入解析
    def _parse_dft_log(self) -> List[str]
    def _parse_dft_violations(self, log_lines, log_path) -> List[Dict]
    
    # 模式匹配
    def _match_forbidden_error(self, violation_name, patterns) -> Optional[str]
    def _find_violations(self, all_violations, forbidden_patterns) -> List[Tuple[str, str]]
    
    # 四种类型执行
    def _execute_type1(self, all_violations, violations_matched) -> CheckResult
    def _execute_type2(self, all_violations, violations_matched) -> CheckResult
    def _execute_type3(self, all_violations, violations_matched) -> CheckResult
    def _execute_type4(self, all_violations, violations_matched) -> CheckResult
    
    # 辅助方法
    def _get_waive_items_with_reasons(self) -> Dict[str, str]
    def _group_by_error_type(self, violations) -> Dict[str, List[str]]
    def _create_error_type_error_groups(self, violations) -> Dict
    def _create_error_type_info_groups(self, violations, prefix) -> Dict
```

### 数据结构

```python
# 违例元数据
self._violation_metadata = {
    "DFT Async Rule Violation:async signal driven...": {
        'error_type': 'DFT Async Rule Violation',
        'description': 'async signal driven to a constant active value...',
        'vid_id': 'vid 0_async',
        'line_number': 33,
        'file_path': 'C:/path/to/synthesis.log'
    }
}

# 豁免映射
waive_items_dict = {
    "DFT Async Rule Violation:async signal...": "Power domain crossing - approved",
    "DFT Clock Rule Violation:internally driven...": "Clock gating required"
}
```

### 正则表达式模式

```python
# 匹配 DFT 检查区域开始
section_start_pattern = re.compile(r'Checking DFT rules for')

# 匹配错误类型
error_pattern = re.compile(r'Error\s*:\s*(DFT\s+\w+\s+Rule\s+Violation)', re.IGNORECASE)

# 匹配违例详情（带 vid）
vid_pattern = re.compile(r':\s*#\s*\d+\s*<(vid\s+\d+_\w+)>:\s*(.+?)(?:\s+\[[\w-]+\])?$')
```

---

## 常见使用场景

### 场景 1: 首次 DFT 检查

**配置**:
```yaml
# Type 1: 检查是否有任何 DFT 违例
requirements:
  value: N/A
waivers:
  value: N/A
```

**预期**: 可能 FAIL，记录所有违例数量和类型

**下一步**: 分析每个违例，决定修复设计还是申请豁免

---

### 场景 2: 优化异步信号违例

**配置**:
```yaml
# Type 2: 只关注异步违例
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"
waivers:
  value: N/A
```

**预期**: 只检查异步违例，时钟违例不影响结果

**用途**: 针对性优化特定类型的 DFT 问题

---

### 场景 3: 管理已知的架构限制

**配置**:
```yaml
# Type 3: 豁免已知的架构约束导致的违例
requirements:
  value: 0
  pattern_items:
    - "DFT Async Rule Violation"
waivers:
  value: 10
  waive_items:
    - name: "DFT Async Rule Violation:async signal driven to a constant active value, module 'power_domain_sync'"
      reason: "Power domain crossing - required by low-power architecture - Ticket#123"
```

**预期**: 已知违例被豁免，新违例会触发 FAIL

**用途**: 增量检查新引入的 DFT 问题

---

### 场景 4: Tape-out 前 DFT 签核

**配置**:
```yaml
# Type 4: 所有违例都需要追踪和批准
requirements:
  value: N/A
waivers:
  value: 50
  waive_items:
    - name: "DFT Async Rule Violation:async signal in module 'approved_module_1'"
      reason: "DFT team final sign-off - cannot be scanned"
    - name: "DFT Clock Rule Violation:clock in module 'clk_tree'"
      reason: "Clock architecture requirement - spec approved"
    # ... 所有已批准的违例
```

**预期**: 确保所有 DFT 违例都经过审查和批准

**用途**: 正式发布前的质量保证

---

## DFT 违例类型说明

### 1. DFT Async Rule Violation

**含义**: 异步 set/reset 信号违反 DFT 规则

**常见原因**:
- 异步信号被驱动为常数激活值
- 极性冲突（polarity conflict）
- 异步信号不可控

**典型示例**:
```
async signal driven to a constant active value, possibly due to a 
polarity conflict in module 'cdnsdrq_data_sync_synth_lh0_4_3', 
net 'genblk1_genblk1_reset_n_inv', inst/pin 'U_cm_cpl_ctrl_if/cb'
```

**影响**: 受影响的寄存器将被排除在扫描链之外

**修复方向**:
- 检查复位信号极性
- 确认异步信号是否可控
- 考虑使用同步复位
- 如果是设计必需，申请豁免

### 2. DFT Clock Rule Violation

**含义**: 时钟信号违反 DFT 规则

**常见原因**:
- 内部驱动的时钟网络
- 时钟网络被绑定为常数
- 未驱动的时钟
- 时钟与异步信号冲突

**修复方向**:
- 确保时钟来自顶层端口
- 检查时钟门控实现
- 验证时钟 MUX 逻辑

### 3. 其他 DFT 违例

根据综合工具可能还有其他类型的 DFT 违例，处理方式类似。

---

## 版本历史

- **2025-11-27**: 重构为 BaseChecker 架构，支持 Type 1/2/3/4
- **2025-11-03**: 初始版本（仅支持 Type 1）

---

## 相关文档

- [Development_prompt.md](../../../Development_prompt.md) - 框架整体架构
- [BaseChecker API](../../../common/base_checker.py) - 基类文档
- [IMP-5-0-0-00_README.md](./IMP-5-0-0-00_README.md) - 库检查参考
- [IMP-5-0-0-13_README.md](./IMP-5-0-0-13_README.md) - DFT 扫描检查参考
- [IMP-5-0-0-14_README.md](./IMP-5-0-0-14_README.md) - 设计规则检查参考
