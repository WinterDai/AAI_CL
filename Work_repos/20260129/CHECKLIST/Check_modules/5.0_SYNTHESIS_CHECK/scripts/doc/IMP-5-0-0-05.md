# IMP-5-0-0-05: 未解析引用检查器

## 概述

**检查项描述:** 确认未解析引用(Unresolved References)为空或已正确豁免

**检查类型:** 统一自动检测型（支持 Type 1/2/3/4 四种模式）

**输入文件:** `synthesis.log`（综合日志文件）

---

## 检查逻辑

### 输入文件解析
- 扫描 synthesis.log 查找 "Check Design Report" 段落
- 在 "Unresolved References" 小节中提取引用名称
- 格式示例：
  ```
  ================================================================================
  Check Design Report (c) Cadence Design Systems, Inc.
  ================================================================================
  
  Unresolved References                                        Empty Modules
  ================================================================================
  
  design top_module has the following unresolved references:
    hinst: blackbox_module_A
    hinst: blackbox_module_B
  
  Total number of unresolved references in design: 2
  ```

### 未解析引用的含义
- **Unresolved Reference（未解析引用）**：综合工具找不到定义的模块
- **常见原因：**
  - 第三方 IP 黑盒（在后续流程中提供）
  - 手工实例化的模块（如 memory、analog block）
  - 拼写错误或路径配置问题

### 违例定义
- **未豁免的未解析引用** = 违例
- Type 1: 所有引用都报告为 INFO（无违例）
- Type 2: 引用数量不符合期望 = 违例
- Type 3/4: 未豁免的引用 = 违例

---

## 自动类型检测

检查器根据配置自动检测运行类型：

| Type | requirements.value | pattern_items | waivers.value | 描述 |
|------|-------------------|---------------|--------------|------|
| Type 1 | N/A | - | N/A 或 0 | 布尔检查（无豁免逻辑） |
| Type 2 | >0 | 有 | N/A 或 0 | 数值比较（无豁免逻辑） |
| Type 3 | >0 | 有 | >0 | 数值比较 + 豁免逻辑 |
| Type 4 | N/A | - | >0 | 布尔检查 + 豁免逻辑 |

---

## Type 1: 布尔检查（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-05:
  check_item: "Confirm Unresolved References are none?"
  requirements:
    value: N/A
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **PASS 场景：** 总是 PASS，无论是否有未解析引用
- **输出内容：**
  - 无引用：报告"未找到未解析引用"
  - 有引用：列出所有未解析引用（作为 INFO）
- **用途：** 信息记录和确认未解析引用状态

### 输出示例

**情况 1：无未解析引用（PASS）**
```
Check Result: PASS
Value: 0

INFO01: Check result:
  - No unresolved references found in synthesis logs
```

详细报告：
```
PASS:IMP-5-0-0-05:Confirm Unresolved References are none?
Info Occurrence: 1
1: Info: No unresolved references found in synthesis logs
```

**情况 2：有未解析引用（PASS）**
```
Check Result: PASS
Value: 3

INFO01: Unresolved references detected:
  - blackbox_module_A
  - blackbox_module_B
  - memory_controller
```

详细报告：
```
PASS:IMP-5-0-0-05:Confirm Unresolved References are none?
Info Occurrence: 3
1: Info: blackbox_module_A. In line 456, synthesis.log: Unresolved reference detected
2: Info: blackbox_module_B. In line 457, synthesis.log: Unresolved reference detected
3: Info: memory_controller. In line 458, synthesis.log: Unresolved reference detected
```

**情况 3：waiver=0 显示模式**
```yaml
waivers:
  value: 0
  waive_items:
    - "Display only"
```

输出：
```
Check Result: PASS (WAIVED)
Value: 2

INFO01:
  - blackbox_module_A: Unresolved reference detected[WAIVED_AS_INFO]
  - blackbox_module_B: Unresolved reference detected[WAIVED_AS_INFO]
  - Display only[WAIVED_AS_INFO]
```

---

## Type 2: 数值比较（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-05:
  check_item: "Confirm Unresolved References are none?"
  requirements:
    value: 0  # 期望 0 个未解析引用
    pattern_items:
      - "0"  # 期望数量
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **比较：** 实际未解析引用数 vs requirements.value
- **PASS 条件：** 实际数量 == 期望数量
- **常用场景：** 期望值通常为 0（不允许任何未解析引用）

### 输出示例

**情况 1：符合期望（0 个，PASS）**
```
Check Result: PASS
Value: 0 (Expected: 0)

INFO01: Check result:
  - No unresolved references found (expected: 0)
```

**情况 2：不符合期望（FAIL）**
```
# 期望 0 个，实际有 2 个
Check Result: FAIL
Value: 2 (Expected: 0)

ERROR01: Unresolved reference count mismatch (found: 2, expected: 0):
  - blackbox_module_A: Unresolved reference count 2 doesn't match expected 0
  - blackbox_module_B: Unresolved reference count 2 doesn't match expected 0
```

**情况 3：期望特定数量（比较少见）**
```yaml
requirements:
  value: 3  # 允许 3 个已知的黑盒模块
  pattern_items: ["3"]
```

实际有 3 个：
```
Check Result: PASS
Value: 3 (Expected: 3)

INFO01: Unresolved reference count matches expected:
  - blackbox_module_A: Unresolved reference count matches expected
  - blackbox_module_B: Unresolved reference count matches expected
  - memory_block: Unresolved reference count matches expected
```

**情况 4：waiver=0 强制通过**
```yaml
waivers:
  value: 0
  waive_items: ["Temporary exception"]
```

输出：
```
Check Result: PASS (WAIVED)
Value: 2

INFO01:
  - blackbox_module_A: Unresolved reference count check waived (expected: 0)[WAIVED_AS_INFO]
  - blackbox_module_B: Unresolved reference count check waived (expected: 0)[WAIVED_AS_INFO]
  - Temporary exception[WAIVED_AS_INFO]
```

---

## Type 3: 数值比较 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-05:
  check_item: "Confirm Unresolved References are none?"
  requirements:
    value: 0
    pattern_items: ["0"]
  waivers:
    value: 2
    waive_items:
      - name: "blackbox_ip_module"
        reason: "Third-party IP, RTL provided post-synthesis"
      - name: "analog_macro"
        reason: "Hardened analog block per design spec"
  input_files:
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **分类引用：**
  - **未豁免引用 → FAIL**（需要解决）
  - **已豁免引用 → INFO**（批准的例外）
  - **未使用豁免 → WARN**（配置清理提示）
- **PASS 条件：** 所有未解析引用都在豁免列表中

### 输出示例

**情况 1：所有引用都已豁免（PASS）**
```
Check Result: PASS
Value: 2

INFO01: Unresolved references waived:
  - blackbox_ip_module: Third-party IP, RTL provided post-synthesis[WAIVER]
  - analog_macro: Hardened analog block per design spec[WAIVER]
```

**情况 2：部分引用未豁免（FAIL）**
```
Check Result: FAIL
Value: 3

ERROR01: Unresolved references not explained:
  - unexpected_module: Unresolved reference is NOT explained

INFO01: Unresolved references waived:
  - blackbox_ip_module: Third-party IP, RTL provided post-synthesis[WAIVER]
  - analog_macro: Hardened analog block per design spec[WAIVER]
```

**情况 3：豁免未使用（PASS with WARN）**
```
Check Result: PASS
Value: 1

INFO01: Unresolved references waived:
  - blackbox_ip_module: Third-party IP, RTL provided post-synthesis[WAIVER]

WARN01: Waived items not found in check:
  - analog_macro: Waived item not found in check[WAIVER]
```

---

## Type 4: 布尔检查 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-05:
  check_item: "Confirm Unresolved References are none?"
  requirements:
    value: N/A
  waivers:
    value: 3
    waive_items:
      - name: "blackbox_ip"
        reason: "Third-party IP module"
      - name: "memory_model"
        reason: "Hardened memory"
      - name: "analog_block"
        reason: "Analog domain, separate flow"
  input_files:
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **布尔检查：** 检查是否存在未解析引用
- **豁免逻辑：** 已知的未解析引用可以豁免
- **PASS 条件：** 所有未解析引用都已豁免
- **最常用类型：** 用于质量检查和黑盒模块管理

### 输出示例

**情况 1：无未解析引用（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: Check result:
  - No unresolved references found in synthesis logs
```

**情况 2：所有引用都已豁免（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: Unresolved references waived:
  - blackbox_ip: Third-party IP module[WAIVER]
  - memory_model: Hardened memory[WAIVER]
  - analog_block: Analog domain, separate flow[WAIVER]
```

**情况 3：存在未豁免引用（FAIL）**
```
Check Result: FAIL
Value: N/A

ERROR01: Unresolved references not explained:
  - unexpected_ref: Unresolved reference is NOT explained

INFO01: Unresolved references waived:
  - blackbox_ip: Third-party IP module[WAIVER]
```

**情况 4：豁免未使用（PASS with WARN）**
```
Check Result: PASS
Value: N/A

INFO01: Unresolved references waived:
  - blackbox_ip: Third-party IP module[WAIVER]

WARN01: Waived items not found in check:
  - memory_model: Waived item not found in check[WAIVER]
  - analog_block: Waived item not found in check[WAIVER]
```

---

## 配置错误处理

### 缺失输入文件

```yaml
input_files:
  - C:\path\to\missing_synthesis.log
```

**输出：**
```
Check Result: FAIL
Value: 0

ERROR01: Configuration error - input files missing or unreadable
  - C:\path\to\missing_synthesis.log: File does not exist
```

### 缺失 Check Design Report

如果 synthesis.log 中没有 "Check Design Report" 段落：

```
Check Result: FAIL
Value: 0

ERROR01: Check Design Report missing:
  - Check Design Report not found: No 'Check Design Report' found in synthesis logs
```

---

## Check Design Report 解析详解

### 报告结构
```
================================================================================
Check Design Report (c) Cadence Design Systems, Inc.
================================================================================

Unresolved References                                        Empty Modules
================================================================================

No unresolved references in design
```

或

```
================================================================================
Unresolved References                                        Empty Modules
================================================================================

design top_module has the following unresolved references:
  hinst: ref_module_1
  hinst: ref_module_2
  hinst: ref_module_3

Total number of unresolved references in design: 3
```

### 提取逻辑
1. 查找 "Check Design Report" 标记
2. 进入 "Unresolved References" 小节
3. 检测 "No unresolved references" → 无引用
4. 或检测 "has the following unresolved references" → 开始提取
5. 提取所有 "hinst: xxx" 行
6. 遇到 "Total number" → 结束提取

---

## 输出文件说明

### Log 文件（分组格式）
- **INFO01:** 
  - 无引用时：显示"未找到未解析引用"
  - 有引用时：列出已豁免引用
- **ERROR01:** 未豁免的未解析引用
- **WARN01:** 未使用的豁免项

### Report 文件（详细列表）
每个未解析引用包含：
- 引用名称（模块名）
- 行号（在 synthesis.log 中的位置）
- 文件路径
- 状态说明（豁免原因或错误信息）

---

## 使用建议

### 1. 初次使用（Type 1）
简单报告未解析引用状态：
```yaml
requirements:
  value: N/A
waivers:
  value: N/A
```

### 2. 严格要求无未解析引用（Type 2）
确保所有模块都已解析：
```yaml
requirements:
  value: 0  # 不允许任何未解析引用
waivers:
  value: N/A
```

### 3. 管理已知黑盒（Type 4 - 推荐）
对于有第三方 IP 或黑盒模块的项目：
```yaml
requirements:
  value: N/A
waivers:
  value: 3
  waive_items:
    - name: "third_party_ip"
      reason: "Purchased IP, JIRA-1234"
    - name: "memory_block"
      reason: "Vendor hardened memory"
    - name: "analog_pll"
      reason: "Analog block, separate signoff"
```

### 4. 允许特定数量（Type 3 - 较少用）
适用于已知有固定数量黑盒的场景：
```yaml
requirements:
  value: 2  # 期望恰好 2 个未解析引用
waivers:
  value: 2
  waive_items:
    - name: "known_black_box_1"
      reason: "Reason 1"
    - name: "known_black_box_2"
      reason: "Reason 2"
```

---

## 常见问题

**Q1: 什么是未解析引用？**
- 综合工具在网表中找到实例化，但找不到模块定义
- 通常是黑盒模块、第三方 IP、或缺失的源文件

**Q2: 未解析引用一定是错误吗？**
- **不一定**。合法场景包括：
  - 第三方 IP 黑盒（后续提供网表）
  - 手工布局的模块（memory、analog）
  - 硬核宏单元
- 但应该都有明确的豁免和原因

**Q3: 引用名称大小写敏感吗？**
- 是的，必须精确匹配
- 豁免项中的名称应与 log 中完全一致

**Q4: 如何区分合法和非法的未解析引用？**
- **合法**：在豁免列表中，有清晰原因和审批
- **非法**：不在豁免列表中，可能是拼写错误或配置问题

**Q5: Type 3 vs Type 4 如何选择？**
- **Type 3**：当需要验证引用数量时（如"必须恰好 2 个黑盒"）
- **Type 4**：当只关心引用是否都已解释时（推荐，更灵活）

**Q6: 豁免原因应该写什么？**
- 模块来源（第三方/内部）
- 为何无法提供 RTL（黑盒/硬核）
- 审批记录（JIRA ticket、负责人）

---

## 豁免最佳实践

### 良好的豁免示例
```yaml
waive_items:
  - name: "pcie_gen4_controller"
    reason: "Synopsys DesignWare IP, license #12345, approved by John Doe"
  
  - name: "sram_1024x32"
    reason: "Vendor hardened SRAM, datasheet v2.3, JIRA-5678"
  
  - name: "analog_pll_core"
    reason: "Custom analog design, separate tape-out flow, ticket #9012"
```

### 不良的豁免示例
```yaml
waive_items:
  - name: "unknown_module"
    reason: "Don't know"  # ❌ 原因不明确
  
  - name: "some_block"
    reason: "Waived"  # ❌ 没有实质信息
  
  - name: "module123"
    reason: "TODO: check later"  # ❌ 临时性，未解决
```

---

## 与其他 Checker 的关联

### IMP-5-0-0-06: Empty Modules
- **05** 检查未解析引用（找不到定义）
- **06** 检查空模块（定义存在但内容为空）

---

## 维护建议

1. **定期审查：** 每次设计变更后检查豁免列表是否仍然有效
2. **豁免文档化：** 在 waive_items 的 reason 中包含 JIRA ticket 或审批记录
3. **WARN01 处理：** 及时清理未使用的豁免（表示模块已解决或不再需要）
4. **版本控制：** 豁免变更应该 review，确保有正当理由

---

**文档版本：** 1.0  
**更新日期：** 2025-11-26  
**作者：** yuyin
