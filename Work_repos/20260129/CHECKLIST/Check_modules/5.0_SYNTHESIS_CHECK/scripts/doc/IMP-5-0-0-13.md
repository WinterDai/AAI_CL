# IMP-5-0-0-13: DFT Scan Insertion Check

## 概述

**检查目标**: 确认扫描链已成功插入，且所有非可扫描触发器都经过同行评审并豁免

**支持的 Checker 类型**: Type 1 / Type 2 / Type 3 / Type 4 (自动检测)

**输入文件**: `dft_chainRegs.rpt` (DFT 扫描链报告)

---

## 检查逻辑

### 核心功能

1. **解析 DFT 报告**
   - 从 `dft_chainRegs.rpt` 提取 9 种类别的非可扫描寄存器
   - 存储每个寄存器的元数据（类别、行号、文件路径）

2. **类别分类**
   - `fail_dft_rules`: 不符合 DFT 规则的寄存器
   - `preserved_or_dont_scan`: 标记为保留或不扫描的寄存器
   - `abstract_segment_dont_scan`: 标记为抽象段不扫描的寄存器
   - `shift_register_segments`: 移位寄存器段的一部分
   - `lockup_elements`: 锁存元件
   - `level_sensitive`: 电平敏感元件
   - `misc_non_scan`: 其他非扫描寄存器
   - `pass_not_in_chains`: 通过 DFT 规则检查但不在扫描链中
   - `abstract_not_in_chains`: 通过检查但不在扫描链中的抽象段

3. **自动类型检测**
   - 根据 YAML 配置自动判断使用 Type 1/2/3/4
   - 支持模式匹配和豁免逻辑

4. **分类输出**
   - 按类别组织 ERROR/INFO/WARN 输出
   - 每个类别单独分组显示

---

## 四种检查类型

### Type 1: 布尔检查（无豁免逻辑）

**配置示例**:
```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: N/A
  waive_items: []
```

**检查逻辑**:
- 检查是否存在任何非可扫描寄存器
- **PASS**: 所有寄存器都可扫描（报告中无非可扫描寄存器）
- **FAIL**: 存在非可扫描寄存器

**输出示例 (PASS)**:
```
PASS:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: 0

INFO01: All registers are scannable
  Severity: Info Occurrence: 0
```

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: 5

ERROR01: Registers fail DFT rules
  Severity: Fail Occurrence: 2
  - fail_dft_rules:u_core/reg_a
  - fail_dft_rules:u_core/reg_b

ERROR02: Registers are misc. non-scan
  Severity: Fail Occurrence: 3
  - misc_non_scan:u_top/reg_c
  - misc_non_scan:u_top/reg_d
  - misc_non_scan:u_top/reg_e
```

**特殊模式 (waiver=0)**:
```yaml
waivers:
  value: 0  # 强制 PASS，所有 FAIL 转为 INFO
```

---

### Type 2: 数值比较（无豁免逻辑）

**配置示例**:
```yaml
requirements:
  value: 0  # 期望违例数
  pattern_items:
    - "fail_dft_rules"      # 精确匹配类别
    - "*misc*"              # 通配符匹配
    - "^preserved.*"        # 正则表达式
waivers:
  value: N/A
  waive_items: []
```

**检查逻辑**:
1. 使用 `pattern_items` 匹配非可扫描寄存器的类别
2. 统计匹配的违例数量
3. 比较：实际违例数 vs `requirements.value`
4. **PASS**: 违例数 == 期望值
5. **FAIL**: 违例数 != 期望值

**模式匹配规则**:
- `fail_dft_rules` → 精确匹配类别名
- `*misc*` → 匹配包含 "misc" 的任何类别
- `^preserved.*` → 正则表达式（以 preserved 开头）

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: 3 (Expected: 0)

Fail Occurrence: 3
1: Fail: fail_dft_rules:u_core/reg_a. In line 45, dft_chainRegs.rpt: Registers fail DFT rules (matches pattern: fail_dft_rules)
2: Fail: misc_non_scan:u_top/reg_b. In line 67, dft_chainRegs.rpt: Registers are misc. non-scan (matches pattern: *misc*)
3: Fail: misc_non_scan:u_top/reg_c. In line 68, dft_chainRegs.rpt: Registers are misc. non-scan (matches pattern: *misc*)

Info Occurrence: 1
1: Info: ^preserved.*. Forbidden category pattern not found (good)
```

---

### Type 3: 数值比较 + 豁免逻辑

**配置示例**:
```yaml
requirements:
  value: 0
  pattern_items:
    - "fail_dft_rules"
    - "*misc*"
waivers:
  value: 3
  waive_items:
    - name: "fail_dft_rules:u_core/reg_a"
      reason: "Approved by architect - Ticket#12345"
    - name: "misc_non_scan:u_top/reg_b"
      reason: "Clock domain crossing, cannot be scanned"
    - name: "misc_non_scan:u_top/reg_unused"
      reason: "This will show as unused waiver"
```

**检查逻辑**:
1. 使用 `pattern_items` 匹配非可扫描寄存器
2. 分离违例:
   - **未豁免违例** → ERROR（需要修复）
   - **已豁免违例** → INFO（批准的例外）
   - **未使用的豁免** → WARN（配置了但未用到）
   - **未匹配的模式** → INFO（未发现违例，好事）
3. **PASS**: len(未豁免违例) == 0
4. **FAIL**: len(未豁免违例) > 0

**输出示例 (PASS - 全部豁免)**:
```
PASS:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: 2 (all waived)

INFO01: Waived: Registers fail DFT rules
  Severity: Info Occurrence: 1
  - fail_dft_rules:u_core/reg_a

INFO02: Waived: Registers are misc. non-scan
  Severity: Info Occurrence: 1
  - misc_non_scan:u_top/reg_b

INFO03: Unmatched patterns (good)
  Severity: Info Occurrence: 0

WARN01: Unused waivers (not found in actual violations)
  Severity: Warn Occurrence: 1
  - misc_non_scan:u_top/reg_unused
```

**输出示例 (FAIL - 部分未豁免)**:
```
FAIL:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: 3 (1 unwaived)

ERROR01: Registers fail DFT rules
  Severity: Fail Occurrence: 1
  - fail_dft_rules:u_core/reg_c

INFO01: Waived: Registers fail DFT rules
  Severity: Info Occurrence: 1
  - fail_dft_rules:u_core/reg_a

INFO02: Waived: Registers are misc. non-scan
  Severity: Info Occurrence: 1
  - misc_non_scan:u_top/reg_b
```

---

### Type 4: 布尔检查 + 豁免逻辑

**配置示例**:
```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: 5
  waive_items:
    - name: "preserved_or_dont_scan:u_clk/clk_gate_reg"
      reason: "Clock gating register, approved by low-power team"
    - name: "level_sensitive:u_analog/async_rst_sync"
      reason: "Async reset synchronizer - Ticket#67890"
    - name: "misc_non_scan:u_core/debug_mode_reg"
      reason: "Debug register, not critical for production test"
```

**检查逻辑**:
1. 检查所有非可扫描寄存器（不使用模式匹配）
2. 分离:
   - **未豁免的** → ERROR（需要修复或豁免）
   - **已豁免的** → INFO（批准的例外）
   - **未使用的豁免** → WARN（配置错误）
3. **PASS**: 所有非可扫描寄存器都有豁免
4. **FAIL**: 存在未豁免的非可扫描寄存器

**输出示例 (PASS)**:
```
PASS:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: N/A

INFO01: Waived: Registers are marked preserved or dont-scan
  Severity: Info Occurrence: 1
  - preserved_or_dont_scan:u_clk/clk_gate_reg

INFO02: Waived: Registers are level-sensitive
  Severity: Info Occurrence: 1
  - level_sensitive:u_analog/async_rst_sync

INFO03: Waived: Registers are misc. non-scan
  Severity: Info Occurrence: 1
  - misc_non_scan:u_core/debug_mode_reg
```

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-13:Confirm scan is successfully inserted
Value: N/A

ERROR01: Registers fail DFT rules
  Severity: Fail Occurrence: 2
  - fail_dft_rules:u_core/new_reg_x
  - fail_dft_rules:u_core/new_reg_y

INFO01: Waived: Registers are marked preserved or dont-scan
  Severity: Info Occurrence: 1
  - preserved_or_dont_scan:u_clk/clk_gate_reg

INFO02: Waived: Registers are level-sensitive
  Severity: Info Occurrence: 1
  - level_sensitive:u_analog/async_rst_sync
```

---

## 输入文件格式

### dft_chainRegs.rpt 结构

```
Reporting registers that fail DFT rules
  u_core/reg_a
  u_core/reg_b

Reporting registers that are preserved or marked dont-scan
  u_clk/clk_gate_reg

Reporting registers that are misc. non-scan registers
  u_top/debug_reg
  u_top/status_reg

Summary:
  Total registers that fail DFT rules: 2
  Total registers that are marked preserved or dont-scan: 1
  Total registers that are misc. non-scan: 2
  ...
```

**解析逻辑**:
1. 识别各个 section header（使用正则表达式）
2. 提取每个 section 下的寄存器列表
3. 从 Summary 获取统计数据验证
4. 记录每个寄存器的行号和文件路径

---

## 输出格式

### 寄存器命名格式

```
category:register_name
```

示例:
- `fail_dft_rules:u_core/reg_a`
- `misc_non_scan:u_top/debug_reg`
- `preserved_or_dont_scan:u_clk/clk_gate_reg`

### 分组策略

**Type 1/2**: 按违例类型分组
```
ERROR01: Registers fail DFT rules
ERROR02: Registers are misc. non-scan
```

**Type 3/4**: 按类别和严重性分组
```
ERROR01: Registers fail DFT rules (unwaived)
ERROR02: Registers are misc. non-scan (unwaived)
INFO01: Waived: Registers fail DFT rules
INFO02: Waived: Registers are misc. non-scan
WARN01: Unused waivers
```

---

## 配置切换示例

### 场景 1: 初始检查（严格模式）

**需求**: 不允许任何非可扫描寄存器

```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: N/A
  waive_items: []
```

**结果**: Type 1 - 发现任何非可扫描寄存器都会 FAIL

---

### 场景 2: 特定类别限制

**需求**: 只允许特定类别的非可扫描寄存器

```yaml
requirements:
  value: 0
  pattern_items:
    - "fail_dft_rules"    # 禁止 DFT 规则失败
    - "*misc*"            # 禁止杂项非扫描
waivers:
  value: N/A
  waive_items: []
```

**结果**: Type 2 - 只检查匹配模式的类别

---

### 场景 3: 批准例外（推荐）

**需求**: 允许经过审批的特定非可扫描寄存器

```yaml
requirements:
  value: 0
  pattern_items:
    - "fail_dft_rules"
waivers:
  value: 2
  waive_items:
    - name: "fail_dft_rules:u_core/special_reg"
      reason: "Architectural requirement - Ticket#12345"
    - name: "fail_dft_rules:u_analog/pll_ctrl"
      reason: "PLL control, cannot be scanned"
```

**结果**: Type 3 - 未豁免的违例 = FAIL，已豁免 = INFO

---

### 场景 4: 全面管理

**需求**: 所有非可扫描寄存器都需要豁免理由

```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: 10
  waive_items:
    - name: "preserved_or_dont_scan:u_clk/clk_gate"
      reason: "Clock gating - approved"
    - name: "level_sensitive:u_rst/sync"
      reason: "Reset synchronizer"
    # ... 更多豁免项
```

**结果**: Type 4 - 所有寄存器要么可扫描，要么有豁免

---

## 最佳实践

### 1. 豁免命名规范

```yaml
waive_items:
  - name: "category:full_hierarchical_path"
    reason: "Brief reason - Ticket#XXXXX"
```

### 2. 豁免理由要求

- ✅ **好的理由**: "Clock gating register approved by low-power team - Ticket#12345"
- ✅ **好的理由**: "Async reset synchronizer, functional requirement - Email dated 2025-11-20"
- ❌ **差的理由**: "Waived"
- ❌ **差的理由**: "Cannot fix"

### 3. 定期审查

- 每次设计变更后重新运行检查
- 检查 WARN（未使用的豁免）→ 删除过时的豁免项
- 新增非可扫描寄存器 → 需要同行评审并添加豁免

### 4. 渐进式严格化

**阶段 1** (初期开发):
```yaml
# Type 4: 允许所有类别，但需要豁免
requirements:
  value: N/A
waivers:
  value: 20
```

**阶段 2** (设计稳定):
```yaml
# Type 3: 限制某些类别
requirements:
  value: 0
  pattern_items:
    - "fail_dft_rules"  # 不允许 DFT 规则失败
waivers:
  value: 10
```

**阶段 3** (接近 Tape-out):
```yaml
# Type 2: 严格检查
requirements:
  value: 0
  pattern_items:
    - "fail_dft_rules"
    - "*misc*"
waivers:
  value: N/A  # 不允许豁免
```

---

## 故障排查

### 问题 1: "No libraries found in qor.rpt"

**原因**: 输入文件路径错误或文件不存在

**解决**:
```yaml
input_files: C:\Users\yuyin\Desktop\CHECKLIST\IP_project_folder\reports\dft_chainRegs.rpt
```

检查:
1. 路径是否正确（绝对路径）
2. 文件是否存在
3. 文件是否可读

---

### 问题 2: 豁免未生效

**症状**: 已豁免的寄存器仍然显示为 FAIL

**原因**: 豁免项名称与报告中的名称不匹配

**检查**:
1. 寄存器名称必须包含类别前缀
   - ✅ `"fail_dft_rules:u_core/reg_a"`
   - ❌ `"u_core/reg_a"` (缺少类别)

2. 大小写敏感
   - ✅ `"misc_non_scan:u_TOP/reg"`
   - ❌ `"misc_non_scan:u_top/reg"` (如果报告中是大写)

---

### 问题 3: WARN - 未使用的豁免

**症状**: `WARN01: Unused waivers`

**原因**: 豁免项在报告中找不到

**可能性**:
1. 设计已修复，寄存器变为可扫描 → **删除豁免项**
2. 寄存器名称拼写错误 → **修正名称**
3. 报告未更新 → **重新生成 dft_chainRegs.rpt**

---

### 问题 4: 类型检测错误

**症状**: 检查器使用了错误的类型

**调试**:
```python
# 在代码中添加打印
checker_type = self.detect_checker_type()
print(f"DEBUG: Detected Type {checker_type}")
```

**验证配置**:
- Type 1: `requirements.value=N/A` AND `waivers.value=N/A`
- Type 2: `requirements.value>0` AND `pattern_items存在` AND `waivers.value=N/A`
- Type 3: `requirements.value>0` AND `pattern_items存在` AND `waivers.value>0`
- Type 4: `requirements.value=N/A` AND `waivers.value>0`

---

## 技术细节

### 核心类和方法

```python
class DFTScanChecker(BaseChecker):
    # 主执行流程
    def execute_check(self) -> CheckResult
    
    # 输入解析
    def _parse_dft_chain_rpt(self) -> List[str]
    def _extract_summary(self, lines) -> Dict[str, int]
    def _extract_registers_for_section(self, lines, section_key) -> Tuple[List[str], int]
    
    # 模式匹配
    def _match_forbidden_category(self, reg_name, patterns) -> Optional[str]
    def _find_violations(self, all_registers, forbidden_patterns) -> List[Tuple[str, str]]
    
    # 四种类型执行
    def _execute_type1(self, all_registers, violations) -> CheckResult
    def _execute_type2(self, all_registers, violations) -> CheckResult
    def _execute_type3(self, all_registers, violations) -> CheckResult
    def _execute_type4(self, all_registers, violations) -> CheckResult
    
    # 辅助方法
    def _get_waive_items_with_reasons(self) -> Dict[str, str]
    def _group_by_category(self, registers) -> Dict[str, List[str]]
    def _create_category_error_groups(self, unwaived_regs) -> Dict
```

### 数据结构

```python
# 寄存器元数据
self._reg_metadata = {
    "fail_dft_rules:u_core/reg_a": {
        'category': 'fail_dft_rules',
        'register': 'u_core/reg_a',
        'line_number': 45,
        'file_path': 'C:/path/to/dft_chainRegs.rpt'
    }
}

# 豁免映射
waive_items_dict = {
    "fail_dft_rules:u_core/reg_a": "Approved by architect - Ticket#12345",
    "misc_non_scan:u_top/reg_b": "Clock domain crossing"
}
```

---

## 版本历史

- **2025-11-27**: 重构为 BaseChecker 架构，支持 Type 1/2/3/4
- **2025-11-04**: 迁移到 BooleanCheckerWithWaiverBase（仅 Type 4）
- **2025-11-03**: 初始版本

---

## 相关文档

- [Development_prompt.md](../../../Development_prompt.md) - 框架整体架构
- [BaseChecker API](../../../common/base_checker.py) - 基类文档
- [IMP-5-0-0-00_README.md](./IMP-5-0-0-00_README.md) - 参考实现示例
