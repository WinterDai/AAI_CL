# IMP-5-0-0-10: 禁用单元检查器

## 概述

**检查项描述：** 确认综合网表中未实例化 IMP-1-0-0-02 指定的禁用单元列表

**检查类型：** 统一自动检测型（支持 Type 1/2/3/4 四种模式）

**输入文件：** `gates.rpt`（综合门级网表报告）

**参考配置：** `IMP-1-0-0-02.yaml`（禁用单元列表定义）

---

## 配置文件关联

该 checker 的配置分为两个文件：

1. **IMP-1-0-0-02.yaml**（Library Check 模块）
   - 定义禁用单元的 pattern_items（支持正则表达式）
   - 定义期望值 requirements.value
   - 作为禁用单元的权威来源

2. **IMP-5-0-0-10.yaml**（本 checker）
   - 定义豁免配置 waivers
   - 指定输入文件路径
   - 根据 waivers.value 决定检查类型

---

## 检查逻辑

### 禁用单元来源
- 从 `IMP-1-0-0-02.yaml` 的 `requirements.pattern_items` 读取
- 支持正则表达式匹配：
  - `*INVD1*` - 匹配包含 INVD1 的所有单元
  - `^INVD1.*` - 匹配以 INVD1 开头的单元
  - 精确匹配单元名称

### 输入文件解析
- 解析 `gates.rpt` 第一列作为单元名称
- 格式示例：`INVD1BWP143M117H3P48CPDLVT  3  0.051  library  0`
- 提取单元名称：`INVD1BWP143M117H3P48CPDLVT`

### 违例匹配
- 使用正则表达式匹配单元名称与禁用模式
- **"Matched" = 违例**（找到了禁用单元）
- **"Unmatched" = 良好**（未找到禁用模式）

---

## 自动类型检测

检查器根据配置自动检测运行类型：

| Type | IMP-1-0-0-02.requirements.value | IMP-5-0-0-10.waivers.value | 描述 |
|------|--------------------------------|----------------------------|------|
| Type 1 | N/A | N/A 或 0 | 布尔检查（无豁免逻辑） |
| Type 2 | >0 且有 pattern_items | N/A 或 0 | 数值比较（无豁免逻辑） |
| Type 3 | >0 且有 pattern_items | >0 | 数值比较 + 豁免逻辑 |
| Type 4 | N/A | >0 | 布尔检查 + 豁免逻辑 |

---

## Type 1: 布尔检查（无豁免逻辑）

### 配置示例

**IMP-1-0-0-02.yaml:**
```yaml
requirements:
  value: N/A
  pattern_items:
    - "*INVD1*"
    - "^NAND.*"
```

**IMP-5-0-0-10.yaml:**
```yaml
waivers:
  value: N/A  # 或 0
  waive_items: []
```

### 检查行为

- **PASS 场景：** gates.rpt 中未找到任何匹配禁用模式的单元
- **FAIL 场景：** gates.rpt 中找到匹配禁用模式的单元

### 输出示例

**情况 1：无违例（PASS）**
```
Check Result: PASS
Value: 0
```

**情况 2：有违例（FAIL）**
```
Check Result: FAIL
Value: 2

ERROR01: Use cell list includes forbidden cells specified in IMP-1-0-0-02
  - INVD1BWP143 (Line 45, gates.rpt): Forbidden cell found (matches pattern: *INVD1*)
  - NAND2D1BWP (Line 78, gates.rpt): Forbidden cell found (matches pattern: ^NAND.*)
```

**情况 3：waiver=0 强制通过**
```yaml
waivers:
  value: 0  # 强制 PASS，转换 FAIL 为 INFO
  waive_items:
    - "Review pending"
```

输出：
```
Check Result: PASS (WAIVED)
Value: 0

INFO01:
  - INVD1BWP143: Forbidden cell found (matches pattern: *INVD1*)[WAIVED_AS_INFO]
  - NAND2D1BWP: Forbidden cell found (matches pattern: ^NAND.*)[WAIVED_AS_INFO]
  - Review pending: Waiver item[WAIVED_AS_INFO]
```

---

## Type 2: 数值比较（无豁免逻辑）

### 配置示例

**IMP-1-0-0-02.yaml:**
```yaml
requirements:
  value: 0  # 期望违例数量为 0
  pattern_items:
    - "*INVD1*"
    - "*NAND2*"
    - "*NOR3*"
```

**IMP-5-0-0-10.yaml:**
```yaml
waivers:
  value: N/A
  waive_items: []
```

### 检查行为

- **比较：** 实际违例数量 vs IMP-1-0-0-02.requirements.value
- **PASS 条件：** 实际违例数 == 期望值
- **显示未匹配模式：** 未找到的禁用模式显示为 INFO（表示良好）

### 输出示例

**情况 1：符合期望值（PASS）**
```
Check Result: PASS
Value: 0 (Expected: 0)

INFO01:
  - *INVD1*: Forbidden pattern not found in gates.rpt (good)
  - *NAND2*: Forbidden pattern not found in gates.rpt (good)
  - *NOR3*: Forbidden pattern not found in gates.rpt (good)
```

**情况 2：违例数不符合期望（FAIL）**
```
Check Result: FAIL
Value: 2 (Expected: 0)

ERROR01: Use cell list includes forbidden cells specified in IMP-1-0-0-02
  - INVD1BWP143: Forbidden cell found (matches pattern: *INVD1*)
  - NAND2D1BWP: Forbidden cell found (matches pattern: *NAND2*)

INFO01:
  - *NOR3*: Forbidden pattern not found in gates.rpt (good)
```

**情况 3：waiver=0 强制通过**
```yaml
waivers:
  value: 0
  waive_items: ["Temporary exception"]
```

输出：
```
Check Result: PASS (WAIVED)
Value: 2

INFO01:
  - INVD1BWP143: Forbidden cell found (matches pattern: *INVD1*)[WAIVED_AS_INFO]
  - NAND2D1BWP: Forbidden cell found (matches pattern: *NAND2*)[WAIVED_AS_INFO]
  - Temporary exception: Waiver item[WAIVED_AS_INFO]
```

---

## Type 3: 数值比较 + 豁免逻辑

### 配置示例

**IMP-1-0-0-02.yaml:**
```yaml
requirements:
  value: 0
  pattern_items:
    - "*INVD1*"
    - "*NAND2*"
    - "*NOR3*"
```

**IMP-5-0-0-10.yaml:**
```yaml
waivers:
  value: 2  # 允许 2 个豁免项
  waive_items:
    - name: "INVD1BWP143"
      reason: "Required for critical path timing"
    - name: "NAND2D1BWP"
      reason: "Low power optimization"
```

### 检查行为

- **分类违例：**
  - **未豁免违例 → FAIL**（需要修复）
  - **已豁免违例 → INFO**（批准的例外）
  - **未使用豁免 → WARN**（配置了但未用到）
  - **未匹配模式 → INFO**（良好，未找到禁用单元）

### 输出示例

**情况 1：所有违例都有豁免（PASS）**
```
Check Result: PASS
Value: 2

INFO01: Waived violations and unmatched patterns (good)
  - INVD1BWP143: Required for critical path timing[WAIVER]
  - NAND2D1BWP: Low power optimization[WAIVER]
  - *NOR3*: Forbidden pattern not found in gates.rpt (good)
```

**情况 2：存在未豁免违例（FAIL）**
```
Check Result: FAIL
Value: 3

ERROR01: Unwaived forbidden cells found
  - NOR3D1BWP: Forbidden cell found (matches pattern: *NOR3*)

INFO01: Waived violations and unmatched patterns (good)
  - INVD1BWP143: Required for critical path timing[WAIVER]
  - NAND2D1BWP: Low power optimization[WAIVER]
```

**情况 3：豁免未使用（PASS with WARN）**
```
Check Result: PASS
Value: 1

INFO01: Waived violations and unmatched patterns (good)
  - INVD1BWP143: Required for critical path timing[WAIVER]
  - *NAND2*: Forbidden pattern not found in gates.rpt (good)
  - *NOR3*: Forbidden pattern not found in gates.rpt (good)

WARN01: Unused waivers (not found in actual violations)
  - NAND2D1BWP: Waived item not found in check[WAIVER]
```

---

## Type 4: 布尔检查 + 豁免逻辑

### 配置示例

**IMP-1-0-0-02.yaml:**
```yaml
requirements:
  value: N/A
  pattern_items:
    - "*INVD1*"
    - "*NAND2*"
```

**IMP-5-0-0-10.yaml:**
```yaml
waivers:
  value: 1
  waive_items:
    - name: "INVD1BWP143"
      reason: "Timing critical path requirement"
```

### 检查行为

- 布尔检查：检查是否存在禁用单元
- 豁免逻辑：将违例分为已豁免/未豁免
- **PASS 条件：** 所有违例都有豁免

### 输出示例

**情况 1：所有违例都有豁免（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: Waived violations (approved exceptions)
  - INVD1BWP143: Timing critical path requirement[WAIVER]
```

**情况 2：存在未豁免违例（FAIL）**
```
Check Result: FAIL
Value: N/A

ERROR01: Unwaived forbidden cells found (Boolean check with waiver)
  - NAND2D1BWP: Forbidden cell found (matches pattern: *NAND2*)

INFO01: Waived violations (approved exceptions)
  - INVD1BWP143: Timing critical path requirement[WAIVER]
```

**情况 3：豁免未使用（PASS with WARN）**
```
Check Result: PASS
Value: N/A

WARN01: Unused waivers (not found in violations)
  - INVD1BWP143: Waived item not found in check[WAIVER]
```

---

## 输出文件说明

### Log 文件（分组格式）
- **ERROR01:** 未豁免的违例（需要修复）
- **WARN01:** 未使用的豁免项（配置清理建议）
- **INFO01:** 已豁免违例 + 未匹配模式（信息展示）

### Report 文件（详细列表）
每个违例包含：
- 单元名称
- 行号（在 gates.rpt 中的位置）
- 文件路径
- 原因说明（匹配的禁用模式）

---

## 使用建议

### 1. 初次使用（Type 1）
从简单的布尔检查开始，确认是否存在禁用单元：
```yaml
# IMP-1-0-0-02.yaml
requirements:
  value: N/A
  pattern_items: ["*INVD1*"]

# IMP-5-0-0-10.yaml
waivers:
  value: N/A
```

### 2. 添加数值目标（Type 2）
明确期望的违例数量：
```yaml
# IMP-1-0-0-02.yaml
requirements:
  value: 0  # 目标：0 个违例
```

### 3. 管理已知例外（Type 3/4）
对于合理的违例，使用豁免管理：
```yaml
# IMP-5-0-0-10.yaml
waivers:
  value: 2
  waive_items:
    - name: "INVD1BWP143"
      reason: "Critical timing requirement per bug#12345"
    - name: "NAND2D1BWP"
      reason: "Power optimization approved by architect"
```

### 4. 临时强制通过（waiver=0）
用于调试或临时豁免所有违例：
```yaml
waivers:
  value: 0
  waive_items: ["Under review - ticket #67890"]
```

---

## 正则表达式示例

| 模式 | 说明 | 匹配示例 |
|------|------|----------|
| `*INVD1*` | 包含 INVD1 | INVD1BWP, MYINVD1CELL |
| `^INVD1` | 以 INVD1 开头 | INVD1BWP, INVD1X2 |
| `INVD1$` | 以 INVD1 结尾 | MYINVD1, TESTINVD1 |
| `^INVD1.*BWP$` | INVD1 开头，BWP 结尾 | INVD1X2BWP |
| `INVD1\|NAND2` | 包含 INVD1 或 NAND2 | INVD1BWP, NAND2D1 |

---

## 常见问题

**Q1: 为什么 Type 检测失败？**
- 检查 IMP-1-0-0-02.yaml 的 requirements.value 是否设置正确
- 确认 pattern_items 列表不为空

**Q2: 豁免项不生效？**
- 确认豁免项名称与 gates.rpt 中的单元名称完全一致
- 检查 waivers.value > 0

**Q3: 正则表达式不匹配？**
- 使用 `*` 通配符代替 `.*`（自动转换）
- 特殊字符需要转义（如 `.` 需要写成 `\.`）

**Q4: WARN01 报告未使用豁免？**
- 这是正常行为，表示配置的豁免项在当前检查中未找到对应违例
- 可能原因：违例已修复、豁免项名称错误

---

## 维护建议

1. **定期审查豁免项：** 检查 WARN01 中的未使用豁免，清理过时配置
2. **豁免原因必填：** 每个豁免项应包含清晰的 reason 和 ticket 编号
3. **模式优化：** 避免过于宽泛的模式（如 `*D1*`），容易误匹配
4. **版本控制：** IMP-1-0-0-02.yaml 变更需要评审，影响所有引用它的 checker

---

**文档版本：** 1.0  
**更新日期：** 2025-11-25  
**作者：** yuyin
