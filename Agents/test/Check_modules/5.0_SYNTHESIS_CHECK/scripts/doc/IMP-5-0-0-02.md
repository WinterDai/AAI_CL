# IMP-5-0-0-02: QRC 技术文件检查器

## 概述

**检查项描述：** 确认综合使用 QRC 技术文件进行 RC（Resistance-Capacitance）数据提取

**检查类型：** 统一自动检测型（支持 Type 1/2/3/4 四种模式）

**输入文件：** `qor.rpt`（综合质量报告）、`synthesis.log`（综合日志）

---

## 检查逻辑

### 输入文件解析流程
这是最复杂的 checker 之一，需要解析多个文件的关联信息：

1. **从 qor.rpt 提取 domain 列表**
   ```
   Library domain: tcond_ssgnp_0p675v_m40c_cworst_CCworst_T
     Domain: DIGITAL_DOMAIN
     Domain: ANALOG_DOMAIN
   ```

2. **在 synthesis.log 中查找每个 domain 的 rc_corner**
   ```
   set_rc_corner -corner cworst_CCworst_T -qrc_tech /path/to/qrcTechFile
   ```

3. **验证 qrc_tech 文件路径是否存在**

### QRC 文件提取链
```
qor.rpt → domains → synthesis.log → rc_corner → qrc_tech → 文件路径
```

### 违例定义
- **缺失 QRC 文件** = 违例
- 某个 domain 未配置 rc_corner
- rc_corner 未指定 qrc_tech 文件
- qrc_tech 文件路径在日志中未找到

---

## 自动类型检测

检查器根据配置自动检测运行类型：

| Type | requirements.value | pattern_items | waivers.value | 描述 |
|------|-------------------|---------------|--------------|------|
| Type 1 | N/A | - | N/A 或 0 | 布尔检查（无豁免逻辑） |
| Type 2 | >0 | 有 | N/A 或 0 | 数值比较（无豁免逻辑） |
| Type 3 | >0 | 有 | >0 | 数值比较 + 豁免逻辑 |
| Type 4 | N/A | - | >0 | 布尔检查 + 豁免逻辑 |

---

## Type 1: 布尔检查（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-02:
  check_item: "Confirm synthesis is using qrc tech file for RC data?"
  requirements:
    value: N/A
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\reports\qor.rpt
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **PASS 场景：** 总是 PASS，无论找到或未找到 QRC 文件
- **输出内容：** 
  - 找到 QRC 文件：列出所有 domain 的 QRC 路径
  - 未找到：报告哪些 domain 缺失 QRC
- **用途：** 信息记录和确认 RC 数据来源

### 输出示例

**情况 1：检测到 QRC 文件（PASS）**
```
Check Result: PASS
Value: 1

INFO01: QRC tech files detected (design IS using QRC for RC data):
  - /process/tsmcN3/data/ge/QRC/15M1Xa1Xb1Xc1Xd1Ya1Yb4Y2Yy2Z_SHDMIM_UT/fs_v1d1p1a/cworst/Tech/cworst_CCworst_T/qrcTechFile
```

详细报告：
```
PASS:IMP-5-0-0-02:Confirm synthesis is using qrc tech file for RC data?
Info Occurrence: 1
1: Info: /process/tsmcN3/.../qrcTechFile. In line 234, synthesis.log: QRC tech file is being used for RC extraction
```

**情况 2：未检测到 QRC 文件（PASS）**
```
Check Result: PASS
Value: 0

INFO01: No QRC tech files detected:
  - DIGITAL_DOMAIN: rc_corner not found or qrc_tech not specified
```

**情况 3：waiver=0 显示模式**
```yaml
waivers:
  value: 0
  waive_items:
    - "Display only"
```

输出：
```
Check Result: PASS (WAIVED)
Value: 1

INFO01:
  - /process/.../qrcTechFile[WAIVED_AS_INFO]
  - Display only[WAIVED_AS_INFO]
```

---

## Type 2: 数值比较（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-02:
  check_item: "Confirm synthesis is using qrc tech file for RC data?"
  requirements:
    value: 1  # 期望所有 domain 都有 QRC
    pattern_items:
      - "*/qrcTechFile"  # 期望的 QRC 文件路径模式
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\reports\qor.rpt
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **比较：** 实际找到的 QRC 文件数 vs requirements.value
- **PASS 条件：** 所有 domain 都配置了 QRC 文件
- **模式匹配：** 可选验证 QRC 文件路径格式

### 输出示例

**情况 1：所有 domain 都有 QRC（PASS）**
```
Check Result: PASS
Value: 2

INFO01: All domains have QRC tech files:
  - DIGITAL_DOMAIN: /process/.../qrcTechFile
  - ANALOG_DOMAIN: /process/.../qrcTechFile
```

**情况 2：部分 domain 缺失 QRC（FAIL）**
```
Check Result: FAIL
Value: 1 (Expected: 2 domains with QRC)

ERROR01: Some domains missing QRC tech files:
  - ANALOG_DOMAIN: rc_corner not configured or qrc_tech not specified

INFO01: Domains with QRC (good):
  - DIGITAL_DOMAIN: /process/.../qrcTechFile
```

**情况 3：waiver=0 强制通过**
```yaml
waivers:
  value: 0
  waive_items: ["Temporary exception"]
```

输出：
```
Check Result: PASS (WAIVED)
Value: 1

INFO01:
  - ANALOG_DOMAIN: QRC check waived[WAIVED_AS_INFO]
  - Temporary exception[WAIVED_AS_INFO]
```

---

## Type 3: 数值比较 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-02:
  check_item: "Confirm synthesis is using qrc tech file for RC data?"
  requirements:
    value: 1
    pattern_items:
      - "*/qrcTechFile"
  waivers:
    value: 1
    waive_items:
      - name: "ANALOG_DOMAIN"
        reason: "Analog domain uses SPICE models instead of QRC"
  input_files:
    - C:\path\to\reports\qor.rpt
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **分类 domain：**
  - 有 QRC 的 domain → INFO（良好）
  - 无 QRC 但已豁免的 domain → INFO with [WAIVER]
  - 无 QRC 且未豁免的 domain → FAIL
- **PASS 条件：** 所有无 QRC 的 domain 都在豁免列表中

### 输出示例

**情况 1：所有 domain 都正常（PASS）**
```
Check Result: PASS
Value: 2

INFO01: All domains have QRC or are waived:
  - DIGITAL_DOMAIN: /process/.../qrcTechFile (using QRC)
  - IO_DOMAIN: /process/.../qrcTechFile (using QRC)
```

**情况 2：缺失但已豁免（PASS）**
```
Check Result: PASS
Value: 1

INFO01: QRC status with approved exceptions:
  - DIGITAL_DOMAIN: /process/.../qrcTechFile (using QRC)
  - ANALOG_DOMAIN: Analog domain uses SPICE models instead of QRC[WAIVER]
```

**情况 3：缺失且未豁免（FAIL）**
```
Check Result: FAIL
Value: 1

ERROR01: Domains missing QRC without waiver:
  - IO_DOMAIN: rc_corner not configured

INFO01: Domains with QRC or waived:
  - DIGITAL_DOMAIN: /process/.../qrcTechFile
  - ANALOG_DOMAIN: Analog domain uses SPICE models instead of QRC[WAIVER]
```

---

## Type 4: 布尔检查 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-02:
  check_item: "Confirm synthesis is using qrc tech file for RC data?"
  requirements:
    value: N/A
  waivers:
    value: 1
    waive_items:
      - name: "ANALOG_DOMAIN"
        reason: "Custom RC extraction method"
  input_files:
    - C:\path\to\reports\qor.rpt
    - C:\path\to\logs\synthesis.log
```

### 检查行为

- **布尔检查：** 检查是否使用了 QRC 文件
- **豁免逻辑：** 特定 domain 可以不使用 QRC
- **PASS 条件：** 所有未使用 QRC 的 domain 都已豁免

### 输出示例

**情况 1：所有 domain 都有 QRC（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: QRC tech files in use:
  - DIGITAL_DOMAIN: /process/.../qrcTechFile
  - IO_DOMAIN: /process/.../qrcTechFile
```

**情况 2：部分 domain 豁免（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: QRC status:
  - DIGITAL_DOMAIN: /process/.../qrcTechFile (using QRC)
  - ANALOG_DOMAIN: Custom RC extraction method[WAIVER]
```

**情况 3：未豁免的缺失（FAIL）**
```
Check Result: FAIL
Value: N/A

ERROR01: Domains missing QRC without waiver:
  - IO_DOMAIN: rc_corner not configured

INFO01: Waived domains:
  - ANALOG_DOMAIN: Custom RC extraction method[WAIVER]
```

---

## 配置错误处理

### 缺失输入文件

```yaml
input_files:
  - C:\path\to\missing_qor.rpt
  - C:\path\to\synthesis.log
```

**输出：**
```
Check Result: FAIL
Value: 0

ERROR01: Configuration error - input files missing or unreadable
  - C:\path\to\missing_qor.rpt: File does not exist
```

### qor.rpt 无 domain 信息

如果 qor.rpt 中没有 "Library domain:" 或 "Domain:" 行：

```
Check Result: PASS (Type 1)
或
Check Result: FAIL (Type 2/3/4)

INFO01: No domains detected in qor.rpt
```

---

## 复杂解析流程详解

### 步骤 1: 提取 Domain 列表
从 qor.rpt 的 "Library domain:" 段落：
```
Library domain: tcond_ssgnp_0p675v_m40c_cworst_CCworst_T
  Domain: DIGITAL_DOMAIN
  Domain: ANALOG_DOMAIN
  Domain: IO_DOMAIN
```

提取结果：`["DIGITAL_DOMAIN", "ANALOG_DOMAIN", "IO_DOMAIN"]`

### 步骤 2: 在 synthesis.log 中查找 rc_corner
对每个 domain，查找对应的 `set_rc_corner` 命令：
```
set_rc_corner -corner cworst_CCworst_T -qrc_tech /path/to/qrcTechFile
```

### 步骤 3: 提取 qrc_tech 文件路径
从 `set_rc_corner` 命令中提取 `-qrc_tech` 参数后的路径

### 步骤 4: 记录元数据
存储每个 QRC 文件的：
- 文件路径
- 所属 domain
- 行号（在 synthesis.log 中的位置）

---

## 输出文件说明

### Log 文件（分组格式）
- **INFO01:** 检测到的 QRC 文件路径和已豁免 domain
- **ERROR01:** 缺失 QRC 的 domain（未豁免）
- **WARN01:** 未使用的豁免项

### Report 文件（详细列表）
每个 QRC 文件包含：
- 完整文件路径
- 所属 domain
- 行号（在 synthesis.log 中的位置）
- 状态说明

---

## 使用建议

### 1. 初次使用（Type 1）
简单报告 QRC 使用状态：
```yaml
requirements:
  value: N/A
waivers:
  value: N/A
```

### 2. 强制所有 domain 使用 QRC（Type 2）
确保每个 domain 都配置了 QRC：
```yaml
requirements:
  value: 1  # 期望全部 domain 有 QRC
waivers:
  value: N/A
```

### 3. 管理特殊 domain（Type 3/4）
某些 domain 可以不使用 QRC：
```yaml
waivers:
  value: 2
  waive_items:
    - name: "ANALOG_DOMAIN"
      reason: "Uses SPICE for analog blocks"
    - name: "MEMORY_DOMAIN"
      reason: "Hardened memory, no RC extraction needed"
```

---

## 常见问题

**Q1: 为什么检测不到 QRC 文件？**
- 检查 qor.rpt 中是否有 "Domain:" 行
- 确认 synthesis.log 中有对应的 `set_rc_corner` 命令
- 验证 `-qrc_tech` 参数是否存在

**Q2: Domain 名称大小写敏感吗？**
- 是的，domain 名称必须精确匹配
- 豁免项中的 domain 名称也必须完全一致

**Q3: 可以豁免特定的 QRC 文件路径吗？**
- 不可以，豁免是基于 **domain 名称**
- 如果某个 domain 缺失 QRC，可以豁免整个 domain

**Q4: 为什么同一个 domain 有多个 QRC 文件？**
- 通常一个 domain 只对应一个 rc_corner
- 如果有多个，checker 会记录所有找到的 QRC 文件

**Q5: synthesis.log 中没有 set_rc_corner 怎么办？**
- 可能是综合工具未配置 RC corner
- 或者使用了默认配置（未显式指定）
- 这种情况会被检测为"缺失 QRC"

---

## RC 提取方法对比

| 方法 | 描述 | 精度 | 适用场景 |
|------|------|------|---------|
| **QRC** | Quantus RC Extraction | 高 | 数字电路、标准单元 |
| **SPICE** | SPICE 级提取 | 最高 | 模拟电路、定制电路 |
| **统计模型** | 基于工艺节点的统计模型 | 低 | 早期估算 |
| **无提取** | 仅使用线负载模型 | 最低 | 快速迭代、功能验证 |

---

## 与其他 Checker 的关联

### IMP-5-0-0-00: Library Models
- **00** 检查时序模型（.lib）
- **02** 检查 RC 模型（QRC tech file）

### IMP-5-0-0-01: LEF Data
- **01** 检查物理布局信息（LEF）
- **02** 检查寄生参数提取（QRC）

### IMP-5-0-0-03: Library Corner
- **02** 验证 rc_corner 配置
- **03** 验证 library corner 一致性

---

## 维护建议

1. **Domain 管理：** 新增 domain 时，确保配置 rc_corner
2. **豁免文档化：** 豁免的 domain 应有清晰的技术原因
3. **路径验证：** 定期检查 QRC 文件路径是否有效
4. **日志完整性：** 确保 synthesis.log 包含所有 set_rc_corner 命令

---

**文档版本：** 1.0  
**更新日期：** 2025-11-26  
**作者：** yuyin
