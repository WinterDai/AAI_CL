# IMP-5-0-0-14: Design Rule Violation Check

## 概述

**检查目标**: 确认没有设计规则违例（最大电容、最大转换时间、最大扇出等）

**支持的 Checker 类型**: Type 1 / Type 2 / Type 3 / Type 4 (自动检测)

**输入文件**: `design_check_rule.rpt` (设计规则检查报告)

---

## 检查逻辑

### 核心功能

1. **解析设计规则报告**
   - 从 `design_check_rule.rpt` 提取 3 种设计规则违例
   - 存储每个违例的元数据（引脚、违例值、行号、文件路径）

2. **规则类型分类**
   - `max_transition`: 最大转换时间违例
   - `max_capacitance`: 最大电容违例
   - `max_fanout`: 最大扇出违例

3. **自动类型检测**
   - 根据 YAML 配置自动判断使用 Type 1/2/3/4
   - 支持规则类型模式匹配和豁免逻辑

4. **分类输出**
   - 按规则类型组织 ERROR/INFO/WARN 输出
   - 每个规则类型单独分组显示
   - 自动检测并警告 `no constraints` 情况

---

## 四种检查类型

### Type 1: 布尔检查（无豁免逻辑）

**配置示例**:
```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: N/A
  waive_items: []
```

**检查逻辑**:
- 检查是否存在任何设计规则违例
- **PASS**: 所有设计规则都通过（无违例）
- **FAIL**: 存在任何设计规则违例

**输出示例 (PASS)**:
```
PASS:IMP-5-0-0-14:No design rule violations
Value: 0

INFO01: All design rules clean
  Severity: Info Occurrence: 0

WARN01: Max_fanout has no constraints
  Severity: Warn Occurrence: 0
```

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-14:Design rule violations found
Value: 5

ERROR01: Max transition violation
  Severity: Fail Occurrence: 3
  - UDFF_th1/Q
  - UBUF_fm/Y
  - UDFF_to/Q

ERROR02: Max capacitance violation
  Severity: Fail Occurrence: 2
  - u_core/net_123
  - u_top/data_bus[0]

WARN01: Max_fanout has no constraints
  Severity: Warn Occurrence: 0
```

**特殊模式 (waiver=0)**:
```yaml
waivers:
  value: 0  # 强制 PASS，所有 FAIL 转为 INFO
```

---

### Type 2: 数值比较（无豁免逻辑）

**配置示例**:
```yaml
requirements:
  value: 0  # 期望违例数
  pattern_items:
    - "max_transition"      # 精确匹配规则类型
    - "*capacitance*"       # 通配符匹配
    - "^max_fanout$"        # 正则表达式
waivers:
  value: N/A
  waive_items: []
```

**检查逻辑**:
1. 使用 `pattern_items` 匹配特定规则类型的违例
2. 统计匹配的违例数量
3. 比较：实际违例数 vs `requirements.value`
4. **PASS**: 违例数 == 期望值
5. **FAIL**: 违例数 != 期望值

**模式匹配规则**:
- `max_transition` → 精确匹配规则类型
- `*capacitance*` → 匹配包含 "capacitance" 的任何规则类型
- `^max_.*` → 正则表达式（以 max_ 开头）

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-14:Design rule violations
Value: 5 (Expected: 0)

Fail Occurrence: 5
1: Fail: UDFF_th1/Q. In line 33, design_check_rule.rpt: Max transition violation (matches pattern: max_transition)
2: Fail: UBUF_fm/Y. In line 37, design_check_rule.rpt: Max transition violation (matches pattern: max_transition)
3: Fail: u_core/net_123. In line 45, design_check_rule.rpt: Max capacitance violation (matches pattern: *capacitance*)
4: Fail: u_core/net_456. In line 46, design_check_rule.rpt: Max capacitance violation (matches pattern: *capacitance*)
5: Fail: UDFF_to/Q. In line 41, design_check_rule.rpt: Max transition violation (matches pattern: max_transition)

Info Occurrence: 0

Warn Occurrence: 1
1: Warn: Max_fanout design rule has no constraints. In line 48, design_check_rule.rpt
```

---

### Type 3: 数值比较 + 豁免逻辑

**配置示例**:
```yaml
requirements:
  value: 0
  pattern_items:
    - "max_transition"
    - "max_capacitance"
waivers:
  value: 3
  waive_items:
    - name: "max_transition:UDFF_th1/Q"
      reason: "Critical timing path - approved by timing team - Ticket#12345"
    - name: "max_capacitance:u_core/net_123"
      reason: "High drive strength buffer planned for next revision"
    - name: "max_transition:UNUSED_PIN"
      reason: "This will show as unused waiver warning"
```

**检查逻辑**:
1. 使用 `pattern_items` 匹配特定规则类型的违例
2. 分离违例:
   - **未豁免违例** → ERROR（需要修复）
   - **已豁免违例** → INFO（批准的例外）
   - **未使用的豁免** → WARN（配置了但未用到）
   - **未匹配的模式** → INFO（未发现违例，好事）
3. **PASS**: len(未豁免违例) == 0
4. **FAIL**: len(未豁免违例) > 0

**输出示例 (PASS - 全部豁免)**:
```
PASS:IMP-5-0-0-14:All violations waived
Value: 2 (all waived)

INFO01: Waived: Max transition violation
  Severity: Info Occurrence: 1
  - UDFF_th1/Q

INFO02: Waived: Max capacitance violation
  Severity: Info Occurrence: 1
  - u_core/net_123

INFO03: Unmatched patterns (good)
  Severity: Info Occurrence: 0

WARN01: Max_fanout has no constraints
  Severity: Warn Occurrence: 0

WARN02: Unused waivers (not found in actual violations)
  Severity: Warn Occurrence: 1
  - max_transition:UNUSED_PIN
```

**输出示例 (FAIL - 部分未豁免)**:
```
FAIL:IMP-5-0-0-14:Unwaived violations found
Value: 5 (2 unwaived)

ERROR01: Max transition violation
  Severity: Fail Occurrence: 2
  - UBUF_fm/Y
  - UDFF_to/Q

INFO01: Waived: Max transition violation
  Severity: Info Occurrence: 1
  - UDFF_th1/Q

INFO02: Waived: Max capacitance violation
  Severity: Info Occurrence: 1
  - u_core/net_123

WARN01: Max_fanout has no constraints
  Severity: Warn Occurrence: 0
```

---

### Type 4: 布尔检查 + 豁免逻辑

**配置示例**:
```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: 10
  waive_items:
    - name: "max_transition:UDFF_th1/Q"
      reason: "Critical path timing approved - cannot be fixed"
    - name: "max_capacitance:u_core/high_cap_net"
      reason: "Power grid net - high capacitance is expected"
    - name: "max_fanout:clk_gate/out"
      reason: "Clock tree fanout - functional requirement"
```

**检查逻辑**:
1. 检查所有设计规则违例（不使用模式匹配）
2. 分离:
   - **未豁免的** → ERROR（需要修复或豁免）
   - **已豁免的** → INFO（批准的例外）
   - **未使用的豁免** → WARN（配置错误）
3. **PASS**: 所有违例都有豁免
4. **FAIL**: 存在未豁免的违例

**输出示例 (PASS)**:
```
PASS:IMP-5-0-0-14:All violations are waived
Value: N/A

INFO01: Waived: Max transition violation
  Severity: Info Occurrence: 3
  - UDFF_th1/Q
  - UBUF_fm/Y
  - UDFF_to/Q

INFO02: Waived: Max capacitance violation
  Severity: Info Occurrence: 1
  - u_core/high_cap_net

INFO03: Waived: Max fanout violation
  Severity: Info Occurrence: 1
  - clk_gate/out

WARN01: Max_fanout has no constraints
  Severity: Warn Occurrence: 0
```

**输出示例 (FAIL)**:
```
FAIL:IMP-5-0-0-14:Unwaived violations exist
Value: N/A

ERROR01: Max transition violation
  Severity: Fail Occurrence: 2
  - new_pin1/Q
  - new_pin2/Y

INFO01: Waived: Max transition violation
  Severity: Info Occurrence: 1
  - UDFF_th1/Q

INFO02: Waived: Max capacitance violation
  Severity: Info Occurrence: 1
  - u_core/high_cap_net

WARN01: Max_fanout has no constraints
  Severity: Warn Occurrence: 0
```

---

## 输入文件格式

### design_check_rule.rpt 结构

```
Max_transition design rule (violation total = 238)
Pin                          Slew (ps)           Max     Violation
---------------------------------------------------------------------
UDFF_th1/Q                          90            29            61
UBUF_fm/Y                          112            29            83
UDFF_to/Q                           94            29            65

Max_capacitance design rule: no violations.

Max_fanout design rule: no constraints.
```

**解析逻辑**:
1. 识别 3 种设计规则的状态行
   - `(violation total = N)` → 有违例
   - `: no violations.` → 无违例
   - `: no constraints.` → 无约束（生成警告）
2. 提取每个违例的引脚名称、违例值和行号
3. 记录元数据用于后续匹配和输出

---

## 输出格式

### 违例命名格式

```
rule_type:pin_name
```

示例:
- `max_transition:UDFF_th1/Q`
- `max_capacitance:u_core/net_123`
- `max_fanout:clk_gate/out`

### 分组策略

**Type 1/2**: 按规则类型分组
```
ERROR01: Max transition violation
ERROR02: Max capacitance violation
ERROR03: Max fanout violation
```

**Type 3/4**: 按规则类型和严重性分组
```
ERROR01: Max transition violation (unwaived)
ERROR02: Max capacitance violation (unwaived)
INFO01: Waived: Max transition violation
INFO02: Waived: Max capacitance violation
WARN01: Max_fanout has no constraints
WARN02: Unused waivers
```

---

## 配置切换示例

### 场景 1: 初始检查（严格模式）

**需求**: 不允许任何设计规则违例

```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: N/A
  waive_items: []
```

**结果**: Type 1 - 发现任何违例都会 FAIL

---

### 场景 2: 关注特定规则

**需求**: 只检查 max_transition 违例

```yaml
requirements:
  value: 0
  pattern_items:
    - "max_transition"
waivers:
  value: N/A
  waive_items: []
```

**结果**: Type 2 - 只统计 max_transition 违例，其他规则忽略

---

### 场景 3: 批准例外（推荐）

**需求**: 允许经过审批的特定违例

```yaml
requirements:
  value: 0
  pattern_items:
    - "max_transition"
    - "max_capacitance"
waivers:
  value: 5
  waive_items:
    - name: "max_transition:critical_path/Q"
      reason: "Timing ECO approved - Ticket#67890"
    - name: "max_capacitance:power_net"
      reason: "Power grid design requirement"
```

**结果**: Type 3 - 未豁免的违例 = FAIL，已豁免 = INFO

---

### 场景 4: 全面管理

**需求**: 所有违例都需要豁免理由

```yaml
requirements:
  value: N/A
  pattern_items: []
waivers:
  value: 50
  waive_items:
    - name: "max_transition:pin1/Q"
      reason: "Critical timing path"
    - name: "max_capacitance:net1"
      reason: "High capacitance by design"
    # ... 更多豁免项
```

**结果**: Type 4 - 所有违例要么修复，要么有豁免

---

## 最佳实践

### 1. 豁免命名规范

```yaml
waive_items:
  - name: "rule_type:full_pin_path"
    reason: "Brief reason - Ticket#XXXXX or Email reference"
```

**示例**:
```yaml
waive_items:
  - name: "max_transition:u_core/critical_ff/Q"
    reason: "Timing analysis approved - cannot optimize further - Ticket#12345"
  - name: "max_capacitance:u_pwr/vdd_grid"
    reason: "Power grid design - high cap is intentional - Email 2025-11-20"
```

### 2. 豁免理由要求

- ✅ **好的理由**: "Critical timing path - timing team approved - cannot be fixed without impacting performance - Ticket#12345"
- ✅ **好的理由**: "Power grid net - high capacitance is by design requirement - Spec Section 4.2"
- ❌ **差的理由**: "Waived"
- ❌ **差的理由**: "Cannot fix"

### 3. 定期审查

- 每次综合后重新运行检查
- 检查 WARN（未使用的豁免）→ 删除过时的豁免项
- 新增违例 → 需要分析根因并添加豁免或修复

### 4. 渐进式严格化

**阶段 1** (初期开发):
```yaml
# Type 4: 允许所有规则类型，但需要豁免
requirements:
  value: N/A
waivers:
  value: 100
```

**阶段 2** (设计优化):
```yaml
# Type 3: 限制某些规则
requirements:
  value: 0
  pattern_items:
    - "max_transition"  # 重点优化 transition
waivers:
  value: 20
```

**阶段 3** (接近 Tape-out):
```yaml
# Type 2: 严格检查
requirements:
  value: 0
  pattern_items:
    - "max_transition"
    - "max_capacitance"
    - "max_fanout"
waivers:
  value: N/A  # 不允许豁免
```

---

## 故障排查

### 问题 1: "Missing input files"

**原因**: 输入文件路径错误或文件不存在

**解决**:
```yaml
input_files: C:\Users\yuyin\Desktop\CHECKLIST\IP_project_folder\reports\design_check_rule.rpt
```

检查:
1. 路径是否正确（绝对路径）
2. 文件是否存在
3. 文件是否可读

---

### 问题 2: 豁免未生效

**症状**: 已豁免的违例仍然显示为 FAIL

**原因**: 豁免项名称与报告中的名称不匹配

**检查**:
1. 违例名称必须包含规则类型前缀
   - ✅ `"max_transition:UDFF_th1/Q"`
   - ❌ `"UDFF_th1/Q"` (缺少规则类型)

2. 引脚路径必须完全匹配
   - ✅ `"max_transition:UDFF_th1/Q"`
   - ❌ `"max_transition:udff_th1/q"` (大小写不同)

3. 检查报告中的实际引脚名称
   ```bash
   # 查看报告中的引脚名称
   cat design_check_rule.rpt | grep "UDFF"
   ```

---

### 问题 3: WARN - Max_fanout has no constraints

**症状**: 
```
WARN01: Max_fanout has no constraints
```

**原因**: 设计中未设置 max_fanout 约束

**解决方案**:

**选项 1 - 添加约束** (推荐):
```tcl
# 在综合脚本中添加
set_max_fanout 16 [current_design]
```

**选项 2 - 接受警告**:
- 如果设计不需要 fanout 约束，可以忽略此警告
- 警告不会导致 FAIL，只是提醒

---

### 问题 4: WARN - 未使用的豁免

**症状**: `WARN02: Unused waivers`

**原因**: 豁免项在报告中找不到

**可能性**:
1. 设计已修复，违例不存在 → **删除豁免项**
2. 引脚名称拼写错误 → **修正名称**
3. 规则类型错误 → **检查是 max_transition 还是 max_capacitance**
4. 报告未更新 → **重新生成 design_check_rule.rpt**

---

### 问题 5: 类型检测错误

**症状**: 检查器使用了错误的类型

**调试**:
```python
# 在代码中添加打印
checker_type = self.detect_checker_type()
print(f"DEBUG: Detected Type {checker_type}")
```

**验证配置**:
- Type 1: `requirements.value=N/A` AND `waivers.value=N/A`
- Type 2: `requirements.value>0` AND `pattern_items存在` AND `waivers.value=N/A`
- Type 3: `requirements.value>0` AND `pattern_items存在` AND `waivers.value>0`
- Type 4: `requirements.value=N/A` AND `waivers.value>0`

---

## 技术细节

### 核心类和方法

```python
class DesignRuleChecker(BaseChecker):
    # 主执行流程
    def execute_check(self) -> CheckResult
    
    # 输入解析
    def _parse_design_rule_rpt(self) -> List[str]
    def _parse_design_rules(self, lines, report_path) -> Dict[str, Dict]
    
    # 模式匹配
    def _match_forbidden_rule(self, violation_name, patterns) -> Optional[str]
    def _find_violations(self, all_violations, forbidden_patterns) -> List[Tuple[str, str]]
    
    # 四种类型执行
    def _execute_type1(self, all_violations, violations_matched) -> CheckResult
    def _execute_type2(self, all_violations, violations) -> CheckResult
    def _execute_type3(self, all_violations, violations) -> CheckResult
    def _execute_type4(self, all_violations, violations_matched) -> CheckResult
    
    # 辅助方法
    def _get_waive_items_with_reasons(self) -> Dict[str, str]
    def _group_by_rule_type(self, violations) -> Dict[str, List[str]]
    def _create_rule_type_error_groups(self, unwaived_violations) -> Dict
    def _get_rule_description(self, rule_type) -> str
```

### 数据结构

```python
# 违例元数据
self._violation_metadata = {
    "max_transition:UDFF_th1/Q": {
        'rule_type': 'max_transition',
        'pin': 'UDFF_th1/Q',
        'violation_value': '61',
        'line_number': 33,
        'file_path': 'C:/path/to/design_check_rule.rpt'
    }
}

# 豁免映射
waive_items_dict = {
    "max_transition:UDFF_th1/Q": "Critical timing path - approved",
    "max_capacitance:u_core/net_123": "High drive strength buffer planned"
}

# no_constraints 警告
self._violation_metadata['_no_constraints_max_fanout'] = {
    'rule_type': 'max_fanout',
    'line_number': 48,
    'file_path': 'C:/path/to/design_check_rule.rpt'
}
```

### 正则表达式模式

```python
# 匹配违例总数行
violation_pattern = re.compile(
    r'^(Max_\w+\s+design\s+rule)\s*\(violation\s+total\s*=\s*(\d+)\)',
    re.IGNORECASE
)

# 匹配无违例行
no_violation_pattern = re.compile(
    r'^(Max_\w+\s+design\s+rule):\s*no\s+violations',
    re.IGNORECASE
)

# 匹配无约束行
no_constraint_pattern = re.compile(
    r'^(Max_\w+\s+design\s+rule):\s*no\s+constraints',
    re.IGNORECASE
)

# 匹配引脚违例详情
pin_violation_pattern = re.compile(
    r'^([A-Za-z0-9_/\[\]]+)\s+(\d+)\s+(\d+)\s+(\d+)\s*$'
)
```

---

## 常见使用场景

### 场景 1: 首次综合检查

**配置**:
```yaml
# Type 1: 检查是否有任何违例
requirements:
  value: N/A
waivers:
  value: N/A
```

**预期**: 可能 FAIL，记录所有违例数量

**下一步**: 分析违例，决定修复或豁免

---

### 场景 2: 优化 max_transition

**配置**:
```yaml
# Type 2: 只关注 transition 违例
requirements:
  value: 0
  pattern_items:
    - "max_transition"
waivers:
  value: N/A
```

**预期**: 只检查 max_transition，其他规则不影响结果

**用途**: 针对性优化特定设计规则

---

### 场景 3: 临时豁免关键路径

**配置**:
```yaml
# Type 3: 豁免已知的关键路径违例
requirements:
  value: 0
  pattern_items:
    - "max_transition"
waivers:
  value: 3
  waive_items:
    - name: "max_transition:critical_path1/Q"
      reason: "Timing analysis complete - meets spec - Ticket#123"
    - name: "max_transition:critical_path2/Q"
      reason: "Will fix in next ECO - Ticket#456"
```

**预期**: 已知违例被豁免，新违例会触发 FAIL

**用途**: 增量检查新引入的违例

---

### 场景 4: Tape-out 前全面检查

**配置**:
```yaml
# Type 4: 所有违例都需要追踪
requirements:
  value: N/A
waivers:
  value: 20
  waive_items:
    - name: "max_transition:approved_pin1/Q"
      reason: "Final timing sign-off - cannot improve"
    - name: "max_capacitance:power_grid"
      reason: "Power grid design - by spec"
    # ... 所有批准的违例
```

**预期**: 确保所有违例都经过审查和批准

**用途**: 正式发布前的质量保证

---

## 版本历史

- **2025-11-27**: 重构为 BaseChecker 架构，支持 Type 1/2/3/4
- **2025-11-04**: 初始版本（仅支持 Type 1）

---

## 相关文档

- [Development_prompt.md](../../../Development_prompt.md) - 框架整体架构
- [BaseChecker API](../../../common/base_checker.py) - 基类文档
- [IMP-5-0-0-00_README.md](./IMP-5-0-0-00_README.md) - 库检查参考
- [IMP-5-0-0-13_README.md](./IMP-5-0-0-13_README.md) - DFT 扫描检查参考
