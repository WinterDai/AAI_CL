# IMP-5-0-0-01: LEF 数据检查器

## 概述

**检查项描述：** 确认综合使用 LEF 数据进行 PLE（Physical Layout Estimation）优化

**检查类型：** 统一自动检测型（支持 Type 1/2/3/4 四种模式）

**输入文件：** `check.rpt`（综合检查报告）

---

## 检查逻辑

### 输入文件解析
- 解析 `check.rpt` 中的配置项
- 查找关键配置：`lib_lef_consistency_check_enable`
- 格式示例：
  ```
  lib_lef_consistency_check_enable: false
  ```
  或
  ```
  lib_lef_consistency_check_enable = false
  ```

### LEF 使用判断
- **`lib_lef_consistency_check_enable = false`**
  - 表示**未使用 LEF 数据**
  - 综合仅依赖 LIB 模型（无物理信息）
  
- **`lib_lef_consistency_check_enable = true`**
  - 表示**使用 LEF 数据**
  - 综合考虑物理布局进行优化

### 违例定义
- **本 checker 无违例概念**
- 仅报告 LEF 使用状态（信息性检查）
- Type 1 模式下总是 PASS

---

## 自动类型检测

检查器根据配置自动检测运行类型：

| Type | requirements.value | pattern_items | waivers.value | 描述 |
|------|-------------------|---------------|--------------|------|
| Type 1 | N/A | - | N/A 或 0 | 布尔检查（无豁免逻辑） |
| Type 2 | >0 | 有 | N/A 或 0 | 数值比较（无豁免逻辑） |
| Type 3 | >0 | 有 | >0 | 数值比较 + 豁免逻辑 |
| Type 4 | N/A | - | >0 | 布尔检查 + 豁免逻辑 |

---

## Type 1: 布尔检查（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-01:
  check_item: "Confirm synthesis is using lef data for PLE optimization?"
  requirements:
    value: N/A
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\reports\check.rpt
```

### 检查行为

- **PASS 场景：** 总是 PASS，无论 LEF 启用或禁用
- **输出内容：** 报告 `lib_lef_consistency_check_enable` 的值
- **用途：** 信息记录和确认设计策略

### 输出示例

**情况 1：LEF 禁用（PASS）**
```
Check Result: PASS
Value: 1

INFO01: Design is NOT using LEF for PLE optimization (lib_lef_consistency_check_enable = false):
  - lib_lef_consistency_check_enable=false
```

详细报告：
```
PASS:IMP-5-0-0-01:Confirm synthesis is using lef data for PLE optimization?
Info Occurrence: 1
1: Info: lib_lef_consistency_check_enable=false. In line 1, check.rpt: Set to false - Design is NOT using LEF data for PLE optimization
```

**情况 2：LEF 启用（PASS）**
```
Check Result: PASS
Value: 1

INFO01: Design IS using LEF for PLE optimization (lib_lef_consistency_check_enable = true):
  - lib_lef_consistency_check_enable=true
```

详细报告：
```
PASS:IMP-5-0-0-01:Confirm synthesis is using lef data for PLE optimization?
Info Occurrence: 1
1: Info: lib_lef_consistency_check_enable=true. In line 1, check.rpt: Set to true - Design IS using LEF data for PLE optimization
```

**情况 3：waiver=0 显示模式**
```yaml
waivers:
  value: 0
  waive_items:
    - "lib_lef_consistency_check_enable=false"
```

输出：
```
Check Result: PASS (WAIVED)
Value: 1

INFO01:
  - lib_lef_consistency_check_enable=false[WAIVED_AS_INFO]
```

---

## Type 2: 数值比较（无豁免逻辑）

### 配置示例

```yaml
IMP-5-0-0-01:
  check_item: "Confirm synthesis is using lef data for PLE optimization?"
  requirements:
    value: 1  # 期望 LEF 启用
    pattern_items:
      - "lib_lef_consistency_check_enable=true"
  waivers:
    value: N/A
    waive_items: []
  input_files:
    - C:\path\to\reports\check.rpt
```

### 检查行为

- **比较：** 实际配置值 vs pattern_items 中的期望值
- **PASS 条件：** 
  - 如果期望 `true`，则 check.rpt 中必须是 `true`
  - 如果期望 `false`，则 check.rpt 中必须是 `false`

### 输出示例

**情况 1：符合期望（PASS）**
```yaml
pattern_items:
  - "lib_lef_consistency_check_enable=true"
```

```
Check Result: PASS
Value: 1

INFO01: LEF usage matches expected configuration:
  - lib_lef_consistency_check_enable=true: Matched expected value
```

**情况 2：不符合期望（FAIL）**
```yaml
pattern_items:
  - "lib_lef_consistency_check_enable=true"
```

实际值为 `false`：
```
Check Result: FAIL
Value: 1

ERROR01: LEF usage doesn't match expected configuration:
  - lib_lef_consistency_check_enable=false: Expected true but got false
```

**情况 3：waiver=0 强制通过**
```yaml
waivers:
  value: 0
  waive_items: ["Temporary exception"]
```

输出：
```
Check Result: PASS (WAIVED)
Value: 1

INFO01:
  - lib_lef_consistency_check_enable=false: Check waived[WAIVED_AS_INFO]
  - Temporary exception[WAIVED_AS_INFO]
```

---

## Type 3: 数值比较 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-01:
  check_item: "Confirm synthesis is using lef data for PLE optimization?"
  requirements:
    value: 1
    pattern_items:
      - "lib_lef_consistency_check_enable=true"
  waivers:
    value: 1
    waive_items:
      - name: "lib_lef_consistency_check_enable=false"
        reason: "LEF data not available for this library version"
  input_files:
    - C:\path\to\reports\check.rpt
```

### 检查行为

- **模式匹配：** 验证配置值是否符合期望
- **豁免逻辑：** 不符合期望的配置可以豁免
- **PASS 条件：** 配置匹配期望 OR 配置值在豁免列表中

### 输出示例

**情况 1：配置正常（PASS）**
```
Check Result: PASS
Value: 1

INFO01: LEF configuration as expected:
  - lib_lef_consistency_check_enable=true: Matches expected value
```

**情况 2：配置异常但已豁免（PASS）**
```
Check Result: PASS
Value: 1

INFO01: LEF configuration waived:
  - lib_lef_consistency_check_enable=false: LEF data not available for this library version[WAIVER]
```

**情况 3：配置异常未豁免（FAIL）**
```
Check Result: FAIL
Value: 1

ERROR01: LEF configuration mismatch not waived:
  - lib_lef_consistency_check_enable=false: Expected true but got false
```

---

## Type 4: 布尔检查 + 豁免逻辑

### 配置示例

```yaml
IMP-5-0-0-01:
  check_item: "Confirm synthesis is using lef data for PLE optimization?"
  requirements:
    value: N/A
  waivers:
    value: 1
    waive_items:
      - name: "lib_lef_consistency_check_enable=false"
        reason: "Early stage synthesis, LEF not required"
  input_files:
    - C:\path\to\reports\check.rpt
```

### 检查行为

- **布尔检查：** 检查配置项是否存在
- **豁免逻辑：** 特定配置值可以豁免
- **PASS 条件：** 配置存在且已确认

### 输出示例

**情况 1：配置检测到（PASS）**
```
Check Result: PASS
Value: N/A

INFO01: LEF configuration detected:
  - lib_lef_consistency_check_enable=false: Early stage synthesis, LEF not required[WAIVER]
```

**情况 2：配置缺失（FAIL）**
```
Check Result: FAIL
Value: N/A

ERROR01: LEF configuration not found:
  - lib_lef_consistency_check_enable: Configuration item missing in check.rpt
```

---

## 配置错误处理

### 缺失输入文件

```yaml
input_files:
  - C:\path\to\missing_check.rpt  # 文件不存在
```

**输出：**
```
Check Result: FAIL
Value: 0

ERROR01: Configuration error - input files missing or unreadable
  - C:\path\to\missing_check.rpt: File does not exist
```

### check.rpt 无相关配置

如果 check.rpt 中没有 `lib_lef_consistency_check_enable` 配置：

```
Check Result: FAIL (Type 2/3/4)
或
Check Result: PASS (Type 1 with INFO)

INFO01: LEF configuration not found in check.rpt
```

---

## 输出文件说明

### Log 文件（分组格式）
- **INFO01:** LEF 配置状态（启用/禁用）
- **ERROR01:** 配置错误或配置值不符合期望
- **WARN01:** 未使用的豁免项

### Report 文件（详细列表）
每个配置项包含：
- 配置项名称和值
- 行号（在 check.rpt 中的位置）
- 文件路径
- 状态说明

---

## LEF vs LIB 对比

| 特性 | LIB 模型 | LEF 模型 |
|------|---------|---------|
| **包含信息** | 时序信息（延迟、功耗） | 物理信息（尺寸、引脚位置） |
| **综合阶段** | 必需 | 可选 |
| **PLE 优化** | 无法进行 | 可以进行 |
| **面积估算** | 粗略估算 | 精确估算 |
| **时序估算** | 精确 | 更精确（考虑布线） |
| **配置项** | 总是启用 | `lib_lef_consistency_check_enable` |

---

## 使用建议

### 1. 初次使用（Type 1）
简单报告 LEF 使用状态：
```yaml
requirements:
  value: N/A
waivers:
  value: N/A
```

### 2. 强制启用 LEF（Type 2）
确保综合必须使用 LEF 数据：
```yaml
requirements:
  value: 1
  pattern_items:
    - "lib_lef_consistency_check_enable=true"
waivers:
  value: N/A
```

### 3. 允许例外（Type 3/4）
某些情况下 LEF 可以不启用：
```yaml
waivers:
  value: 1
  waive_items:
    - name: "lib_lef_consistency_check_enable=false"
      reason: "Early synthesis stage or library limitation"
```

---

## 常见问题

**Q1: 为什么检测不到配置？**
- 检查 check.rpt 格式是否正确
- 确认配置项名称拼写（注意下划线和等号）
- 支持两种格式：`key: value` 和 `key = value`

**Q2: true/false 大小写敏感吗？**
- 不敏感，支持 `true`, `True`, `TRUE`
- 建议使用小写以保持一致性

**Q3: LEF 禁用会影响综合结果吗？**
- 禁用 LEF：综合速度快，但面积估算不准确
- 启用 LEF：综合慢，但 PLE 优化更好，面积更准确

**Q4: 什么时候应该启用 LEF？**
- **应启用**：后端需要精确面积估算、有 PLE 优化需求
- **可禁用**：早期探索、快速迭代、库没有 LEF 文件

---

## 配置项名称匹配

**重要：** 配置项名称必须完全匹配（包括等号/冒号）

```yaml
# 正确示例 1
pattern_items:
  - "lib_lef_consistency_check_enable=false"

# 正确示例 2（如果 check.rpt 使用冒号）
pattern_items:
  - "lib_lef_consistency_check_enable: false"

# 错误示例（冒号和等号不匹配）
pattern_items:
  - "lib_lef_consistency_check_enable: false"  # check.rpt 中是 "="
```

**已知修复：** 代码已修复 info_groups 匹配问题，现在使用等号格式

---

## 与其他 Checker 的关联

### IMP-5-0-0-00: Library Models
- **00** 检查 `.lib` 时序模型
- **01** 检查 `.lef` 物理模型（本 checker）

### IMP-5-0-0-02: QRC Tech File
- **01** 关注物理布局信息（LEF）
- **02** 关注 RC 提取信息（QRC）

---

## 维护建议

1. **配置格式统一：** 确保 check.rpt 格式一致（等号或冒号）
2. **豁免管理：** LEF 禁用的豁免应包含清晰原因和审批记录
3. **阶段性要求：** 早期可豁免，后期应强制启用

---

**文档版本：** 1.0  
**更新日期：** 2025-11-26  
**作者：** yuyin
